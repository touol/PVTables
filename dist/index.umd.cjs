(function(s,e){typeof exports=="object"&&typeof module<"u"?e(exports,require("vue"),require("primevue/datatable"),require("primevue/column"),require("primevue/button"),require("primevue/toolbar"),require("primevue/dialog"),require("axios"),require("primevue/inputtext"),require("primevue/textarea"),require("primevue/inputnumber"),require("primevue/inputswitch"),require("primevue/autocomplete"),require("primevue/inputgroup"),require("primevue/api")):typeof define=="function"&&define.amd?define(["exports","vue","primevue/datatable","primevue/column","primevue/button","primevue/toolbar","primevue/dialog","axios","primevue/inputtext","primevue/textarea","primevue/inputnumber","primevue/inputswitch","primevue/autocomplete","primevue/inputgroup","primevue/api"],e):(s=typeof globalThis<"u"?globalThis:s||self,e(s.PVTables={},s.Vue,s.DataTable,s.Column,s.Button,s.Toolbar,s.Dialog,s.axios,s.InputText,s.Textarea,s.InputNumber,s.InputSwitch,s.AutoComplete,s.InputGroup,s.api))})(this,function(s,e,re,_,w,ie,z,x,E,J,M,K,oe,ne,I){"use strict";const X={__name:"GTSAutocomplete",props:e.mergeModels({table:{type:String,required:!0}},{id:{type:String,default:""},idModifiers:{}}),emits:e.mergeModels(["update:id"],["update:id"]),setup(U,{emit:$}){const C=e.useModel(U,"id"),f=U,y=e.ref({}),T=p=>{C.value=p.value.id},q=e.ref([]),G=async({query:p})=>{try{const d=await x.post("/api/"+f.table,{},{params:{api_action:"autocomplete",query:p}});q.value=d.data.data.rows}catch(d){console.log(`Autocomplete search error: 
`,d)}};async function A(p){return(await x.post("/api/"+f.table,{},{params:{api_action:"autocomplete",id:p}})).data.data.rows[0]||null}const v=[null,"","0"];e.onBeforeMount(async()=>{if(v.includes(C.value))C.value="";else{const p=await A(C.value);y.value=p}});const c=async p=>{const d=p.target.value;let b={};d!==""&&d!=="0"&&(b=await A(p.target.value)),y.value=b,C.value=d};return(p,d)=>(e.openBlock(),e.createBlock(e.unref(ne),null,{default:e.withCtx(()=>[e.createVNode(e.unref(E),{modelValue:C.value,"onUpdate:modelValue":d[0]||(d[0]=b=>C.value=b),onBlur:c,onKeydown:e.withKeys(c,["enter"])},null,8,["modelValue"]),e.createVNode(e.unref(oe),{modelValue:y.value,"onUpdate:modelValue":d[1]||(d[1]=b=>y.value=b),onItemSelect:T,dropdown:"",onComplete:G,"option-label":"content",suggestions:q.value},null,8,["modelValue","suggestions"])]),_:1}))}},se={class:"card"},de={class:"p-3"},ce={class:"p-field"},ue=["for"],pe=["id"],fe={class:"confirmation-content"},me=e.createElementVNode("i",{class:"pi pi-exclamation-triangle p-mr-3",style:{"font-size":"2rem"}},null,-1),ye={key:0},he={class:"confirmation-content"},we=e.createElementVNode("i",{class:"pi pi-exclamation-triangle p-mr-3",style:{"font-size":"2rem"}},null,-1),be={key:0},j={__name:"PVTables",props:{table:{type:String,required:!0},actions:{type:Object},reload:{type:Boolean},filters:{type:Object,default:{}}},emits:["message"],setup(U,{expose:$,emit:C}){e.defineComponent({name:"PVTables"});const f=U,y=e.ref(),T=()=>{let r={};for(let i in m)if(f.filters.hasOwnProperty(i))r[i]=f.filters[i];else switch(m[i].type){default:r[i]={operator:I.FilterOperator.AND,constraints:[{value:null,matchMode:I.FilterMatchMode.STARTS_WITH}]}}y.value=r},q=r=>{k.value.filters=y.value,N(r)},G=()=>{T(),k.value.filters=y.value,N()},A=r=>"Поиск по "+r.label,v=C,c={add:r=>{v("message",r)}},p=e.ref(),d=e.ref(!0),b=e.ref(0),Y=e.ref(0),k=e.ref({}),L=e.ref([{field:"id",label:"ID"}]);let m={};const V=e.ref();let R=e.ref([]);const H=e.ref(!1),Ve=e.ref(!1),Z=e.ref([]);e.onMounted(async()=>{d.value=!0,k.value={first:p.value.first,rows:p.value.rows,sortField:null,sortOrder:null};try{const r=await x.post("/api/"+f.table,{},{params:{api_action:"options"}});if(!r.data.success){c.add({severity:"error",summary:"Ошибка",detail:r.data.message,life:3e3});return}if(r.data.data.hasOwnProperty("fields")){m=r.data.data.fields;let i=[],o=[];for(let l in m)m[l].field=l,m[l].hasOwnProperty("label")||(m[l].label=l),m[l].hasOwnProperty("type")||(m[l].type="text"),o.push(m[l]),i.push(l);Z.value=i,T();let t=r.data.data.actions;for(let l in f.actions)t[l]=f.actions[l];for(let l in t){let a={...t[l]},u=!0;switch(a.action=l,l){case"update":a.hasOwnProperty("row")||(a.row=!0),a.hasOwnProperty("icon")||(a.icon="pi pi-pencil"),a.hasOwnProperty("class")||(a.class="p-button-rounded p-button-success"),a.hasOwnProperty("click")||(a.click=O=>Be(O));break;case"delete":a.hasOwnProperty("row")||(a.row=!0),a.hasOwnProperty("head")||(a.head=!0),a.hasOwnProperty("icon")||(a.icon="pi pi-trash"),a.hasOwnProperty("class")||(a.class="p-button-rounded p-button-danger"),a.hasOwnProperty("click")||(a.click=O=>Fe(O)),a.hasOwnProperty("head_click")||(a.head_click=()=>Se()),a.hasOwnProperty("label")||(a.label="Удалить");break;case"create":a.hasOwnProperty("head")||(a.head=!0),a.hasOwnProperty("icon")||(a.icon="pi pi-plus"),a.hasOwnProperty("class")||(a.class="p-button-rounded p-button-success"),a.hasOwnProperty("head_click")||(a.head_click=()=>_e()),a.hasOwnProperty("label")||(a.label="Создать");break;case"subtables":u=!1;for(let O in t[l]){let h={...t[l][O]};h.table=O,h.hasOwnProperty("row")||(h.row=!0),h.hasOwnProperty("icon")||(h.icon="pi pi-angle-right"),h.hasOwnProperty("class")||(h.class="p-button-rounded p-button-success"),h.hasOwnProperty("click")||(h.click=qe=>ge(qe,h)),H.value=!0,R.value.push(h)}break}u&&(a.hasOwnProperty("row")&&(H.value=!0),a.hasOwnProperty("row")&&(Ve.value=!0),R.value.push(a))}L.value=o}N()}catch(r){c.add({severity:"error",summary:"Ошибка",detail:r.message,life:3e3}),console.error(r)}});const F=e.ref({}),Q=e.ref({}),ee=e.ref({}),te=async r=>{F.value={...r}},ge=async(r,i)=>{let o={...F.value};if(o.hasOwnProperty(r.id))if(Q.value[r.id]==i.table){delete o[r.id],await te(o);return}else delete o[r.id],await te(o),o[r.id]=!0;else o[r.id]=!0;if(Q.value[r.id]=i.table,i.hasOwnProperty("where")){let t={};for(let l in i.where)t[l]={operator:I.FilterOperator.AND,constraints:[{value:r[i.where[l]],matchMode:I.FilterMatchMode.EQUALS}]};ee.value[r.id]=t}F.value={...o}},N=r=>{d.value=!0,k.value={...k.value,first:(r==null?void 0:r.first)||Y.value};let i={limit:k.value.rows,setTotal:1,offset:k.value.first,multiSortMeta:k.value.multiSortMeta,filters:y.value};x.get("/api/"+f.table,{params:i}).then(function(o){if(!o.data.success){c.add({severity:"error",summary:"Ошибка",detail:o.data.message,life:3e3});return}let t=[];o.data.data.rows.length&&o.data.data.rows.forEach(function(l){for(let a in m)switch(a=="id"&&(l[a]=Number(l[a])),m[a].type){case"boolean":l.hasOwnProperty(a)&&(l[a]==="0"?l[a]=!1:l[a]=!0);break;case"number":case"decimal":l[a]=Number(l[a]);break}t.push(l)}),V.value=t,b.value=o.data.data.total,d.value=!1}).catch(function(o){c.add({severity:"error",summary:"Ошибка",detail:o.message,life:3e3})})},le=()=>{N()};$({refresh:le});const ae=async r=>{let{data:i,newValue:o,field:t}=r;try{const l=await x.patch("/api/"+f.table,{id:i.id,[t]:o});if(!l.data.success){c.add({severity:"error",summary:"Ошибка",detail:l.data.message,life:3e3});return}l.data.success&&(i[t]=o)}catch(l){r.preventDefault(),c.add({severity:"error",summary:"Ошибка",detail:l.message,life:3e3}),console.error(l)}},xe=r=>{k.value=r,N(r)},Ce=r=>{k.value=r,N(r)},Ne=r=>r.toString().replace(".",","),n=e.ref({}),W=e.ref(!1),B=e.ref(!1),Be=r=>{n.value={...r},B.value=!0},Pe=()=>{B.value=!1,W.value=!1},Ue=()=>{W.value=!0,n.value.id?x.patch("/api/"+f.table,n.value).then(r=>{if(!r.data.success){c.add({severity:"error",summary:"Ошибка",detail:r.data.message,life:3e3});return}V.value[Oe(Number(n.value.id))]=n.value,B.value=!1,n.value={}}).catch(function(r){c.add({severity:"error",summary:"Ошибка",detail:r.message,life:3e3})}):x.put("/api/"+f.table,n.value).then(r=>{if(!r.data.success){c.add({severity:"error",summary:"Ошибка",detail:r.data.message,life:3e3});return}d.value=!0,B.value=!1,n.value={},N()}).catch(function(r){c.add({severity:"error",summary:"Ошибка",detail:r.message,life:3e3})})},Oe=r=>{let i=-1;for(let o=0;o<V.value.length;o++)if(V.value[o].id===r){i=o;break}return i},_e=()=>{n.value={},W.value=!1,B.value=!0},D=e.ref(!1),S=e.ref(!1),Fe=r=>{n.value=r,D.value=!0},De=()=>{x.delete("/api/"+f.table+"?ids="+n.value.id).then(r=>{if(!r.data.success){c.add({severity:"error",summary:"Ошибка",detail:r.data.message,life:3e3});return}V.value=V.value.filter(i=>i.id!==n.value.id),D.value=!1,n.value={}}).catch(function(r){c.add({severity:"error",summary:"Ошибка",detail:r.message,life:3e3})})},Se=()=>{g.value&&g.value.length&&(S.value=!0)},Ee=()=>{let r=[];g.value.forEach(function(i){r.push(i.id)}),x.delete("/api/"+f.table+"?ids="+r.join(",")).then(i=>{if(!i.data.success){c.add({severity:"error",summary:"Ошибка",detail:i.data.message,life:3e3});return}V.value=V.value.filter(o=>!g.value.includes(o)),S.value=!1,g.value=null}).catch(function(i){c.add({severity:"error",summary:"Ошибка",detail:i.message,life:3e3})})},g=e.ref(),P=e.ref(!1),Me=r=>{P.value=r.checked,P.value?(P.value=!0,g.value=V.value):(P.value=!1,g.value=[])},Ie=()=>{P.value=g.value.length===b.value},Te=()=>{P.value=!1};return(r,i)=>{const o=e.resolveComponent("PVTables",!0);return e.openBlock(),e.createElementBlock("div",se,[e.createVNode(e.unref(ie),{class:"p-mb-4"},{start:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(R).filter(t=>t.head),t=>(e.openBlock(),e.createBlock(e.unref(w),{icon:t.icon,label:t.label,class:e.normalizeClass(t.class),onClick:t.head_click},null,8,["icon","label","class","onClick"]))),256))]),end:e.withCtx(()=>[e.createVNode(e.unref(w),{icon:"pi pi-refresh",class:"p-button-rounded p-button-success",onClick:le}),e.createVNode(e.unref(w),{type:"button",icon:"pi pi-filter-slash",onClick:i[0]||(i[0]=t=>G())})]),_:1}),e.createVNode(e.unref(re),{value:V.value,lazy:"",paginator:"",first:Y.value,rows:10,rowsPerPageOptions:[10,60,30,10],ref_key:"dt",ref:p,dataKey:"id",totalRecords:b.value,loading:d.value,onPage:i[1]||(i[1]=t=>xe(t)),onSort:i[2]||(i[2]=t=>Ce(t)),sortMode:"multiple",editMode:"cell",onCellEditComplete:ae,selection:g.value,"onUpdate:selection":i[3]||(i[3]=t=>g.value=t),selectAll:P.value,onSelectAllChange:Me,onRowSelect:Ie,onRowUnselect:Te,filters:y.value,"onUpdate:filters":i[4]||(i[4]=t=>y.value=t),filterDisplay:"menu",globalFilterFields:Z.value,onFilter:i[5]||(i[5]=t=>q(t)),expandedRows:F.value,"onUpdate:expandedRows":i[6]||(i[6]=t=>F.value=t),showGridlines:""},{expansion:e.withCtx(t=>[e.createElementVNode("div",de,[e.createVNode(o,{table:Q.value[t.data.id],filters:ee.value[t.data.id]},null,8,["table","filters"])])]),default:e.withCtx(()=>[e.createVNode(e.unref(_),{selectionMode:"multiple",headerStyle:"width: 3rem"}),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(L.value.filter(t=>t.modal_only!=!0),t=>(e.openBlock(),e.createElementBlock(e.Fragment,{key:t.field},[t.field=="id"?(e.openBlock(),e.createBlock(e.unref(_),{key:0,field:"id",header:"id",style:{padding:"1rem 10px 1rem 10px"},sortable:""},{body:e.withCtx(({data:l,field:a})=>[e.createTextVNode(e.toDisplayString(l[a]),1)]),_:1})):t.type=="autocomplete"?(e.openBlock(),e.createBlock(e.unref(_),{key:1,field:t.field,header:t.label,style:{"min-width":"350px"}},{body:e.withCtx(({data:l,field:a})=>[e.createVNode(X,{table:t.table,id:l[a],"onUpdate:id":u=>l[a]=u,onKeydown:e.withKeys(u=>ae({data:l,field:a,newValue:l[a]}),["enter"])},null,8,["table","id","onUpdate:id","onKeydown"])]),_:2},1032,["field","header"])):(e.openBlock(),e.createBlock(e.unref(_),{key:2,field:t.field,header:t.label,style:{"min-width":"12rem"},sortable:""},e.createSlots({filter:e.withCtx(({filterModel:l})=>[e.createVNode(e.unref(E),{modelValue:l.value,"onUpdate:modelValue":a=>l.value=a,type:"text",class:"p-column-filter",placeholder:A(t)},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},[t.type=="decimal"?{name:"body",fn:e.withCtx(({data:l,field:a})=>[e.createTextVNode(e.toDisplayString(Ne(l[a])),1)]),key:"0"}:t.type=="autocomplete"?{name:"body",fn:e.withCtx(()=>[e.createVNode(X,{table:t.table},null,8,["table"])]),key:"1"}:t.type=="boolean"?{name:"body",fn:e.withCtx(({data:l,field:a})=>[e.createVNode(e.unref(K),{modelValue:l[a],"onUpdate:modelValue":u=>l[a]=u},null,8,["modelValue","onUpdate:modelValue"])]),key:"2"}:{name:"body",fn:e.withCtx(({data:l,field:a})=>[e.createTextVNode(e.toDisplayString(l[a]),1)]),key:"3"},t.type=="textarea"?{name:"editor",fn:e.withCtx(({data:l,field:a})=>[e.createVNode(e.unref(J),{modelValue:l[a],"onUpdate:modelValue":u=>l[a]=u,rows:"1"},null,8,["modelValue","onUpdate:modelValue"])]),key:"4"}:t.type=="number"?{name:"editor",fn:e.withCtx(({data:l,field:a})=>[e.createVNode(e.unref(M),{modelValue:l[a],"onUpdate:modelValue":u=>l[a]=u},null,8,["modelValue","onUpdate:modelValue"])]),key:"5"}:t.type=="decimal"?{name:"editor",fn:e.withCtx(({data:l,field:a})=>[e.createVNode(e.unref(M),{modelValue:l[a],"onUpdate:modelValue":u=>l[a]=u,minFractionDigits:t.FractionDigits,maxFractionDigits:t.FractionDigits},null,8,["modelValue","onUpdate:modelValue","minFractionDigits","maxFractionDigits"])]),key:"6"}:t.type=="boolean"?{name:"editor",fn:e.withCtx(({data:l,field:a})=>[e.createVNode(e.unref(K),{modelValue:l[a],"onUpdate:modelValue":u=>l[a]=u},null,8,["modelValue","onUpdate:modelValue"])]),key:"7"}:{name:"editor",fn:e.withCtx(({data:l,field:a})=>[e.createVNode(e.unref(E),{modelValue:l[a],"onUpdate:modelValue":u=>l[a]=u},null,8,["modelValue","onUpdate:modelValue"])]),key:"8"}]),1032,["field","header"]))],64))),128)),H.value?(e.openBlock(),e.createBlock(e.unref(_),{key:0,exportable:!1,style:{"white-space":"nowrap"}},{body:e.withCtx(t=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(R).filter(l=>l.row),l=>(e.openBlock(),e.createBlock(e.unref(w),{icon:l.icon,class:e.normalizeClass(l.class),onClick:a=>l.click(t.data,L.value)},null,8,["icon","class","onClick"]))),256))]),_:1})):e.createCommentVNode("",!0)]),_:1},8,["value","first","totalRecords","loading","selection","selectAll","filters","globalFilterFields","expandedRows"]),e.createVNode(e.unref(z),{visible:B.value,"onUpdate:visible":i[7]||(i[7]=t=>B.value=t),style:{width:"450px"},header:"Редактировать",modal:!0,class:"p-fluid"},{footer:e.withCtx(()=>[e.createVNode(e.unref(w),{label:"Отмена",icon:"pi pi-times",class:"p-button-text",onClick:Pe}),e.createVNode(e.unref(w),{label:"Сохранить",icon:"pi pi-check",class:"p-button-text",onClick:Ue})]),default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(L.value.filter(t=>t.table_only!=!0),t=>(e.openBlock(),e.createElementBlock("div",ce,[e.createElementVNode("label",{for:t.field},e.toDisplayString(t.label),9,ue),t.field=="id"?(e.openBlock(),e.createElementBlock("p",{key:0,id:t.field},e.toDisplayString(n.value[t.field]),9,pe)):t.type=="textarea"?(e.openBlock(),e.createBlock(e.unref(J),{key:1,id:t.field,modelValue:n.value[t.field],"onUpdate:modelValue":l=>n.value[t.field]=l,modelModifiers:{trim:!0}},null,8,["id","modelValue","onUpdate:modelValue"])):t.type=="number"?(e.openBlock(),e.createBlock(e.unref(M),{key:2,id:t.field,modelValue:n.value[t.field],"onUpdate:modelValue":l=>n.value[t.field]=l},null,8,["id","modelValue","onUpdate:modelValue"])):t.type=="decimal"?(e.openBlock(),e.createBlock(e.unref(M),{key:3,id:t.field,modelValue:n.value[t.field],"onUpdate:modelValue":l=>n.value[t.field]=l,minFractionDigits:t.FractionDigits,maxFractionDigits:t.FractionDigits},null,8,["id","modelValue","onUpdate:modelValue","minFractionDigits","maxFractionDigits"])):t.type=="boolean"?(e.openBlock(),e.createBlock(e.unref(K),{key:4,id:t.field,modelValue:n.value[t.field],"onUpdate:modelValue":l=>n.value[t.field]=l},null,8,["id","modelValue","onUpdate:modelValue"])):(e.openBlock(),e.createBlock(e.unref(E),{key:5,id:t.field,modelValue:n.value[t.field],"onUpdate:modelValue":l=>n.value[t.field]=l,modelModifiers:{trim:!0}},null,8,["id","modelValue","onUpdate:modelValue"]))]))),256))]),_:1},8,["visible"]),e.createVNode(e.unref(z),{visible:D.value,"onUpdate:visible":i[9]||(i[9]=t=>D.value=t),style:{width:"450px"},header:"Confirm",modal:!0},{footer:e.withCtx(()=>[e.createVNode(e.unref(w),{label:"Нет",icon:"pi pi-times",class:"p-button-text",onClick:i[8]||(i[8]=t=>D.value=!1)}),e.createVNode(e.unref(w),{label:"Да",icon:"pi pi-check",class:"p-button-text",onClick:De})]),default:e.withCtx(()=>[e.createElementVNode("div",fe,[me,n.value?(e.openBlock(),e.createElementBlock("span",ye,"Вы хотите удалить эту запись?")):e.createCommentVNode("",!0)])]),_:1},8,["visible"]),e.createVNode(e.unref(z),{visible:S.value,"onUpdate:visible":i[11]||(i[11]=t=>S.value=t),style:{width:"450px"},header:"Confirm",modal:!0},{footer:e.withCtx(()=>[e.createVNode(e.unref(w),{label:"Нет",icon:"pi pi-times",class:"p-button-text",onClick:i[10]||(i[10]=t=>S.value=!1)}),e.createVNode(e.unref(w),{label:"Да",icon:"pi pi-check",class:"p-button-text",onClick:Ee})]),default:e.withCtx(()=>[e.createElementVNode("div",he,[we,n.value?(e.openBlock(),e.createElementBlock("span",be,"Вы хотите удалить отмеченные записи?")):e.createCommentVNode("",!0)])]),_:1},8,["visible"])])}}},ke={install:(U,$)=>{U.component(j.name,j)}};s.PVTables=j,s.default=ke,Object.defineProperties(s,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
