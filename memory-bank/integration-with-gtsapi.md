# Интеграция PVTables с gtsAPI

## Введение

PVTables - это компонент для MODX, предназначенный для создания редактируемых html-таблиц. Он интегрируется с gtsAPI для получения данных и выполнения операций CRUD (создание, чтение, обновление, удаление).

## История создания

Для ERP системы на MODX требуется много редактируемых html-таблиц. Функционал большинства таблиц практически одинаков - в основном требуется простой CRUD (создание, чтение, редактирование, удаление записей из базы).

До написания getTables и PVTables для редактируемых таблиц в MODX был только MIGX на EXTJS 3. EXTJS 3 не понравился автору тем, что для простой задачи выдает кучу HTML кода, в котором не легко разобраться. Был сделан getTables на php и jQuery. В принципе с большинством задач он справляется, но позже автор перешел на реактивный фреймворк Vue и решил сделать таблицы на нем.

Для фронтенда был выбран фреймворк PrimeVue, так как в нем для таблиц много готовых компонентов.

## Основной принцип работы

1. В базе данных создаются таблицы, которые нужно редактировать.
2. В таблице gtsAPI "Таблицы API" создается краткое описание (инструкции) нужной таблицы.
3. При вызове сниппета PVTable указывается название таблицы.
4. Затем сниппет подгружает js код PVTables и передает в него название таблицы.
5. PVTables делает запрос к gtsAPI и подгружает описание таблицы, по которому строит таблицу и делает запросы на чтение и запись в gtsAPI.

## Быстрый старт

Для самой простой таблицы в "Таблицы API" нужно:
1. Прописать имя таблицы (если имя совпадает с классом MODX таблицы)
2. Завести и выбрать пакет MODX, к которому привязана таблица
3. В properties прописать действия, доступные для таблицы

## Преимущества PVTables

1. Можно быстро сделать простую таблицу.
2. Описания таблиц можно переиспользовать на других страницах сайта или в других таблицах в качестве подтаблиц.
3. В gtsAPI для таблиц написан стандартный контроллер таблиц, который уже умеет CRUD для произвольных таблиц базы. Нет необходимости для каждой таблицы писать свой контроллер.
4. Можно переиспользовать описания полей типа autocomplete и select.
5. Поддержка кастомных действий через внешние action, сторонние action и триггеры.

## Компоненты PVTables

### UniTreePanel

Компонент UniTreePanel предназначен для отображения древовидных данных. Он используется в OrgStructure для отображения организационной структуры.

### DataTable

Компонент DataTable предназначен для отображения табличных данных с возможностью фильтрации, сортировки и редактирования.

## Работа с UI-фреймворками

### Особенности PrimeVue 4

PVTables использует PrimeVue 4, который имеет другую структуру компонентов по сравнению с предыдущими версиями. При работе с компонентами необходимо учитывать эти особенности:

1. При использовании компонентов табов в PrimeVue 4 используйте правильную структуру:
   ```vue
   <Tabs value="0">
     <TabList>
       <Tab value="0">Заголовок 1</Tab>
       <Tab value="1">Заголовок 2</Tab>
     </TabList>
     <TabPanels>
       <TabPanel value="0">Содержимое 1</TabPanel>
       <TabPanel value="1">Содержимое 2</TabPanel>
     </TabPanels>
   </Tabs>
   ```

### Стили и отображение

1. Компоненты должны занимать все доступное пространство для удобства использования.
2. Используйте flex-контейнеры для правильного распределения пространства.
3. Для полноэкранных компонентов используйте:
   ```css
   .component {
     display: flex;
     flex-direction: column;
     width: 100%;
     height: 100vh;
     overflow: hidden;
   }
   ```

## Использование PVTables в компоненте Vue

Пример использования PVTables в компоненте Vue:

```vue
<template>
  <PVTables table="sraschet"
    :actions="actions"
    ref="childComponentRef"
  />
  <Toast/>
</template>

<script setup>
import { PVTables } from 'pvtables/pvtables';
import { ref } from 'vue';
import Toast from 'primevue/toast';

import apiCtor from 'pvtables/api';
import { useNotifications } from "pvtables/notify";

const childComponentRef = ref()
const createDocDialog = ref(false)
const updateDocDialog = ref(false)

const api = apiCtor('DocOrderLink')

const { notify } = useNotifications();

const actions = ref({
  DocOrderLink:{
    create:{
      head:true,
      icon:"pi pi-plus",
      class:"p-button-rounded p-button-success",
      head_click: async (event,table,filters,selectedlineItems) => {
        // Код для обработки клика по кнопке создания
      }
    },
    update:{
      row:true,
      icon:"pi pi-pencil",
      class:"p-button-rounded p-button-success",
      click: async (data, columns,table,filters) => {
        // Код для обработки клика по кнопке обновления
      }
    }
  },
})
</script>
```

## Работа с API

PVTables предоставляет API для работы с данными. Пример использования API:

```javascript
import apiCtor from 'pvtables/api';
const api = apiCtor('DocOrderLink')
try {
  await api.create(DocLink.value)
} catch (error) {
  notify('error', { detail: error.message });
}
```

## Типы полей

PVTables поддерживает различные типы полей:
- text - текстовое поле
- textarea - многострочное текстовое поле
- boolean - логическое поле (да/нет)
- date - поле для выбора даты
- autocomplete - поле с автозаполнением
- select - поле с выбором из списка

### Autocomplete

autocomplete позволяет выбрать/вставить в таблицу id записи из другой таблицы базы данных. Для настройки autocomplete используется инструкция "autocomplete" в properties таблицы, которая предоставляет данные для автозаполнения.

### Select

Поле select выдает обычный селект. Описания доступных опций селекта забиваются таблице "Селекты" в gtsAPI для того, чтобы их можно было переиспользовать в разных таблицах.

## Дополнительные возможности

### Внешний action

Внешний action используется тогда, когда при нажатии на кнопку нужно показать юзеру какой-то диалог. Тогда пишем компонент vue.

### Сторонний action

Сторонний action используется, когда в gtsAPI действия перенаправляются в сервисный файл компонента.

### Триггеры

Триггеры используются для выполнения дополнительных действий до и после стандартных действий с таблицей.
