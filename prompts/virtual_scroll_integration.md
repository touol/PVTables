# Интеграция виртуального скроллинга в PVTables

## Текущее состояние

Реализована функциональность виртуального скроллинга для PVTables с автоопределением высоты строк.

### Что уже сделано:

1. **Создан composable `src/composables/useVirtualScroll.js`** с полной логикой:
   - Автоопределение высоты строк на основе анализа текстовых полей (text/textarea)
   - Учет ширины колонок из настроек и DOM
   - Сохранение настроек в localStorage
   - Computed свойства для virtualScrollerOptions и rowStyle

2. **Добавлен UI в `src/PVTables.vue`**:
   - Popover с настройками виртуального скроллинга (уже в template)
   - Кнопка в toolbar для открытия настроек (уже в template)
   - Импорты компонентов: ToggleSwitch, InputNumber (уже добавлены)
   - Импорт composable: `import { useVirtualScroll } from "./composables/useVirtualScroll";` (уже добавлен)

## Что нужно доделать для завершения интеграции

### Шаг 1: Инициализировать composable в script setup

**Где:** В `src/PVTables.vue`, в секции `<script setup>`, после строки:
```javascript
const { cacheAction, cache } = useActionsCaching()
```

**Добавить:**
```javascript
// Виртуальный скроллинг
const {
  virtualScrollEnabled,
  rowHeight,
  calculatedRowHeight,
  virtualScrollPopover,
  virtualScrollerOptions,
  onVirtualScrollToggle,
  toggleVirtualScrollSettings,
  recalculateRowHeight,
  getVirtualScrollRowStyle
} = useVirtualScroll({
  columns,
  lineItems,
  dt,
  storageKey: `pvtables-virtual-scroll-${props.table}`
});
```

### Шаг 2: Добавить virtualScrollerOptions в DataTable

**Где:** В `src/PVTables.vue`, в template, в теге `<DataTable>` (примерно строка 130)

**Найти:**
```vue
<DataTable
  :value="lineItems"
  lazy
  paginator
  ...
```

**Добавить атрибут:**
```vue
:virtualScrollerOptions="virtualScrollerOptions"
```

Полный пример:
```vue
<DataTable
  :value="lineItems"
  lazy
  
  :virtualScrollerOptions="virtualScrollerOptions"

  paginator
  :first="first"
  ...
```

### Шаг 3: Заменить функцию rowStyle на обертку

**Где:** В `src/PVTables.vue`, в секции `<script setup>`, найти существующую функцию `rowStyle`

**Найти (примерно строка 2800):**
```javascript
const rowStyle = (data) => {
  if(row_setting.value[data.id] && row_setting.value[data.id].style){
    return row_setting.value[data.id].style;
  }
  return {};
};
```

**Заменить на:**
```javascript
const rowStyle = getVirtualScrollRowStyle((data) => {
  if(row_setting.value[data.id] && row_setting.value[data.id].style){
    return row_setting.value[data.id].style;
  }
  return {};
});
```

## Как это работает

1. **UI взаимодействие:**
   - Пользователь нажимает кнопку с иконкой молнии (⚡) в toolbar
   - Открывается Popover с настройками виртуального скроллинга
   - Можно включить/выключить виртуальный скроллинг
   - Можно настроить высоту строки вручную
   - Кнопка "Пересчитать" автоматически определяет оптимальную высоту

2. **Автоопределение высоты:**
   - Анализируются первые 100 строк данных
   - Для каждой колонки типа text/textarea:
     - Определяется ширина колонки (из настроек или DOM)
     - Вычисляется количество символов на строку
     - Оценивается количество строк текста
     - Рассчитывается необходимая высота ячейки
   - Берется максимальная высота среди всех ячеек
   - Ограничивается 2-3 строками текста для разумной высоты

3. **Применение:**
   - При включении виртуального скроллинга:
     - `virtualScrollerOptions` передает настройки в DataTable PrimeVue
     - `getVirtualScrollRowStyle` оборачивает существующую функцию rowStyle
     - Добавляет фиксированную высоту ко всем строкам
   - При выключении:
     - `virtualScrollerOptions` возвращает null
     - Строки возвращаются к автоматической высоте

4. **Сохранение настроек:**
   - Настройки сохраняются в localStorage с ключом `pvtables-virtual-scroll-${table}`
   - При следующей загрузке таблицы настройки восстанавливаются

## Возможные проблемы и решения

### Проблема: Виртуальный скроллинг не активируется

**Решение:** Убедитесь, что:
1. DataTable PrimeVue поддерживает virtualScrollerOptions (версия 3.x+)
2. Атрибут `scrollable` установлен в true
3. Установлен `scrollHeight`

### Проблема: Строки обрезаются

**Решение:**
1. Увеличьте высоту строки в настройках
2. Нажмите "Пересчитать" для автоопределения
3. Проверьте, что в таблице нет полей с очень длинным текстом

### Проблема: Производительность не улучшилась

**Решение:**
1. Убедитесь, что в таблице действительно много строк (>100)
2. Проверьте, что виртуальный скроллинг включен (кнопка должна быть желтой)
3. Откройте DevTools и проверьте, что рендерятся только видимые строки

## Тестирование

После интеграции протестируйте:

1. **Включение/выключение:**
   - Нажмите кнопку виртуального скроллинга
   - Включите режим
   - Проверьте, что таблица работает
   - Выключите режим
   - Проверьте, что таблица вернулась к обычному режиму

2. **Автоопределение высоты:**
   - Откройте настройки
   - Нажмите "Пересчитать"
   - Проверьте, что высота строки изменилась
   - Проверьте, что текст не обрезается

3. **Ручная настройка:**
   - Измените высоту строки вручную
   - Проверьте, что изменения применились
   - Перезагрузите страницу
   - Проверьте, что настройки сохранились

4. **Производительность:**
   - Загрузите таблицу с большим количеством строк (>1000)
   - Включите виртуальный скроллинг
   - Проверьте плавность прокрутки
   - Откройте DevTools Performance и проверьте FPS

## Дополнительные улучшения (опционально)

1. **Адаптивная высота для разных типов полей:**
   - Можно расширить `calculateOptimalRowHeight` для учета других типов полей
   - Например, для полей с изображениями или вложенными компонентами

2. **Кэширование вычислений:**
   - Можно добавить кэширование результатов `calculateOptimalRowHeight`
   - Пересчитывать только при изменении данных или колонок

3. **Предупреждения пользователю:**
   - Показывать предупреждение, если высота строки слишком мала
   - Предлагать автоматический пересчет при изменении данных

4. **Профили настроек:**
   - Сохранять несколько профилей настроек
   - Быстрое переключение между профилями
