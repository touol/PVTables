# Режим выделения ячеек в DataTable - ЗАВЕРШЕНО

## Описание задачи
Реализован режим выделения ячеек в таблице DataTable с возможностью копирования данных, подсчета суммы и среднего значения для числовых полей.

## Реализованная функциональность

### 1. Режим выделения ячеек
- **Включение/выключение**: Кнопка в тулбаре (иконка меняется на зеленую при активации)
- **Горячая клавиша**: `Ctrl+Shift+S` для переключения режима
- **Визуальное выделение**: Выделенные ячейки подсвечиваются синим фоном

### 2. Способы выделения
- **Одиночная ячейка**: Клик по ячейке
- **Диапазон ячеек**: Клик + перетаскивание мышью
- **Множественное выделение**: `Ctrl + клик` для добавления к существующему выделению
- **Сброс выделения**: Клик без Ctrl сбрасывает предыдущее выделение

### 3. StatusBar (панель статистики)
Отображается под тулбаром при наличии выделенных ячеек:
- **Количество ячеек**: "Выделено: N ячеек" (с правильным склонением)
- **Сумма**: Только для полей типа `decimal` и `number`
- **Среднее**: Только для полей типа `decimal` и `number`
- **Кнопка "Копировать"**: Копирует данные в буфер обмена в TSV формате (для Excel)

### 4. Обработка значений
- **Autocomplete поля**: Берется отображаемый текст (например, название вместо ID)
- **Числовые поля**: Парсятся с учетом форматирования (пробелы, запятые)
- **Текстовые поля**: Берется текст как есть
- **Флаг summable**: Определяет, можно ли суммировать значения (только decimal и number)

## Измененные файлы

### 1. `src/PVTables.vue`
**Добавлено:**
- Состояние режима выделения: `cellSelectionMode`, `selectedCells`, `selectionStart`, `isSelecting`
- Функция `toggleCellSelectionMode()` - переключение режима
- Функция `getCellData(rowIndex, colIndex)` - получение данных ячейки с определением колонки через DOM
- Обработчики мыши: `onCellMouseDown()`, `onCellMouseEnter()`, `onCellMouseUp()`
- Обработчик горячих клавиш: `handleKeyDown()` для Ctrl+Shift+S
- Компонент `StatusBar` в template
- Кнопка переключения режима в тулбаре
- Props для передачи в DataTable: `cellSelectionMode`, `cellSelectionState`

**Ключевые особенности getCellData:**
```javascript
const cellData = {
  rowIndex,
  colIndex: adjustedColIndex,
  field: col.field,
  value: displayValue,      // Отображаемое значение из DOM
  label: col.label,
  summable: isSummable      // true только для decimal и number
};
```

### 2. `src/components/DataTable/StatusBar.vue`
**Новый компонент** для отображения статистики:
- Подсчет количества выделенных ячеек
- Вычисление суммы (только для `summable: true`)
- Вычисление среднего (только для `summable: true`)
- Копирование в буфер обмена в TSV формате
- Адаптивный дизайн для мобильных устройств

### 3. `src/components/DataTable/DataTable.vue`
**Добавлено:**
- Props: `cellSelectionMode`, `cellSelectionState`
- Передача props в `DTTableBody`
- Атрибут `data-cell-selection-mode` на элемент table

### 4. `src/components/DataTable/BaseDataTable.vue`
**Добавлено:**
- Props: `cellSelectionMode`, `cellSelectionState`
- Передача props в `DTTableBody`

### 5. `src/components/DataTable/TableBody.vue`
**Добавлено:**
- Props: `cellSelectionMode`, `cellSelectionState`
- Передача props в `DTBodyRow`

### 6. `src/components/DataTable/BodyRow.vue`
**Добавлено:**
- Props: `cellSelectionMode`, `cellSelectionState`, `rowIndex`
- Передача props в `DTBodyCell`

### 7. `src/components/DataTable/BodyCell.vue`
**Добавлено:**
- Props: `cellSelectionMode`, `cellSelectionState`, `rowIndex`, `colIndex`
- Computed `isCellSelected` - проверка выделения по полю (не по индексу!)
- Обработчики событий мыши: `@mousedown`, `@mouseenter`
- CSS класс `cell-selected` для выделенных ячеек
- Стили для визуального выделения

**Важно:** Сравнение ячеек происходит по `field` и `rowIndex`, а не по `colIndex`, чтобы избежать проблем со скрытыми колонками.

## Стили

### Выделенная ячейка
```css
.cell-selected {
  background-color: rgba(33, 150, 243, 0.1) !important;
  outline: 2px solid #2196F3 !important;
  outline-offset: -2px;
}
```

## Технические детали

### Определение колонки через DOM
Из-за наличия скрытых колонок (tree, checkbox) используется поиск через DOM:
1. Находим ячейку по rowIndex и colIndex
2. Ищем внутри `.td-body`
3. Считаем позицию среди ячеек с `.td-body`
4. Получаем колонку из массива видимых колонок

### Обработка числовых значений
```javascript
if (col.type === 'decimal' || col.type === 'number') {
  const numStr = displayValue.replace(/\s/g, '').replace(',', '.');
  const num = parseFloat(numStr);
  if (!isNaN(num)) {
    displayValue = num;
  }
}
```

### Копирование в Excel
Данные копируются в TSV формате (Tab-Separated Values):
- Строки разделены `\n`
- Столбцы разделены `\t`
- Сортировка по rowIndex и colIndex
- Экранирование табуляций и переносов строк

## Возможные доработки

### Потенциальные улучшения:
1. **Выделение всей строки/столбца**: Клик по заголовку
2. **Выделение диапазона клавиатурой**: Shift + стрелки
3. **Контекстное меню**: Правый клик на выделенных ячейках
4. **Дополнительная статистика**: Минимум, максимум, количество уникальных значений
5. **Форматы экспорта**: CSV, JSON, HTML
6. **Сохранение выделения**: При переключении страниц
7. **Выделение по условию**: Например, все ячейки > 100
8. **История выделений**: Отмена/повтор (Ctrl+Z/Ctrl+Y)

### Известные ограничения:
- Выделение сбрасывается при переключении страниц пагинации
- Не работает выделение для скрытых колонок (modal_only, hidden)
- Режим выделения отключается при выходе из компонента

## Тестирование

### Проверить:
1. ✅ Включение/выключение режима кнопкой
2. ✅ Включение/выключение режима горячей клавишей
3. ✅ Выделение одиночной ячейки
4. ✅ Выделение диапазона перетаскиванием
5. ✅ Множественное выделение с Ctrl
6. ✅ Отображение количества ячеек
7. ✅ Подсчет суммы для числовых полей
8. ✅ Подсчет среднего для числовых полей
9. ✅ Отсутствие суммы для текстовых полей
10. ✅ Копирование в буфер обмена
11. ✅ Вставка в Excel с сохранением структуры
12. ✅ Корректное отображение значений autocomplete

## Исправления

### 01.12.2025 - Исправлена проблема с выделением при скрытом поле id

**Проблема:**
При скрытом поле `id` (когда `hideId = true`) выделялась не та ячейка, а предыдущая в строке. Это происходило из-за несоответствия между:
- Массивом `visibleColumns`, который уже был отфильтрован без поля `id`
- Подсчетом ячеек в DOM, который включал скрытую колонку `id`

**Решение:**
В функции `getCellData` в `src/PVTables.vue`:
1. Добавлена фильтрация скрытого поля `id` при создании массива `visibleColumns`:
   ```javascript
   const visibleColumns = columns.value.filter(c => 
     !c.modal_only && 
     c.type !== 'hidden' && 
     !(hideId.value && c.field === 'id')
   );
   ```

2. При подсчете позиции ячейки добавлена проверка видимости через `window.getComputedStyle`:
   ```javascript
   for (let i = 0; i < colIndex; i++) {
     const cellBodyDiv = cells[i].querySelector('.td-body');
     if (cellBodyDiv) {
       const cellStyle = window.getComputedStyle(cells[i]);
       const isVisible = cellStyle.display !== 'none' && cellStyle.visibility !== 'hidden';
       
       if (isVisible) {
         tdBodyIndex++;
       }
     }
   }
   ```

Теперь выделение работает корректно независимо от того, скрыто поле `id` или нет.

### 02.12.2025 - Исправлена проблема с выделением при виртуальном скроллинге

**Проблема:**
При включенном виртуальном скроллинге с некоторой строки ячейки не выделялись. Это происходило потому, что виртуальный скроллинг PrimeVue рендерит только видимые строки в DOM, и индексы строк в DOM не совпадают с реальными индексами данных.

**Решение:**
В функции `getCellData` в `src/PVTables.vue` изменен способ поиска строки:

**Было:**
```javascript
const rows = table.querySelectorAll('tbody tr');
const targetRow = rows[rowIndex];
```

**Стало:**
```javascript
// Находим строку по data-p-index (работает с виртуальным скроллингом)
const targetRow = table.querySelector(`tbody tr[data-p-index="${rowIndex}"]`);
```

Теперь используется атрибут `data-p-index`, который PrimeVue автоматически добавляет к каждой строке и содержит реальный индекс данных, независимо от того, какие строки отрендерены в DOM. Это решение работает как с виртуальным скроллингом, так и без него.

## Дата завершения
30.11.2025

## Дата последнего обновления
02.12.2025
