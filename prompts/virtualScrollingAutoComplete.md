# Задача: Реализация виртуального скроллинга с ленивой загрузкой в AutoComplete

## Описание проблемы

В компонентах PVAutoComplete и PVMultiAutoComplete при работе с большими списками данных возникают проблемы с производительностью. Когда в автокомплите много записей (например, тысячи), загрузка всех записей сразу приводит к:

1. Медленной работе интерфейса
2. Высокому потреблению памяти
3. Долгому времени отклика при поиске

## Текущая реализация

Сейчас в конфигурации gtsAPIPackages можно установить:
- `limit: 10` - ограничивает количество записей до 10
- `limit: 0` - загружает все записи без ограничений

При `limit: 0` и большом количестве записей автокомплит тормозит.

## Требуемое решение

Нужно реализовать виртуальный скроллинг с ленивой загрузкой, чтобы:

1. Изначально загружалось только первые N записей (например, 10)
2. При скролле списка автоматически подгружались следующие порции записей
3. Использовался виртуальный скроллинг PrimeVue для оптимизации рендеринга

## Техническая реализация

### 1. Компонент AutoComplete
**Важно** AutoComplete скопирован в папку src\components\AutoComplete. Там его можно модифицировать. Нужно пробросить событие `lazy-load` от VirtualScroller.

Изучение исходного кода показало:

```vue
<VirtualScroller 
  :ref="virtualScrollerRef" 
  v-bind="virtualScrollerOptions" 
  :style="{ height: scrollHeight }" 
  :items="visibleOptions" 
  :tabindex="-1" 
  :disabled="virtualScrollerDisabled" 
  :pt="ptm('virtualScroller')"
>
```

VirtualScroller поддерживает событие `lazy-load`, которое срабатывает при скролле до конца списка.

### 2. Параметры virtualScrollerOptions

```javascript
virtualScrollerOptions: {
  itemSize: 38,        // Высота элемента в пикселях
  lazy: true,          // Включает ленивую загрузку
  // НЕТ onLazyLoad - это событие, а не параметр!
}
```

### 3. Событие lazy-load

VirtualScroller генерирует событие `lazy-load`, которое нужно обрабатывать:

```vue
<VirtualScroller @lazy-load="onLazyLoad" />
```

### 4. Структура изменений

#### В компоненте PVAutoComplete.vue:

1. Добавить параметр `:virtualScrollerOptions="{ itemSize: 38, lazy: true }"`
2. Добавить обработчик `@lazy-load="onLazyLoad"`
3. Добавить состояние пагинации:
   ```javascript
   const pagination = reactive({
     offset: 0,
     limit: 10,
     loading: false,
     hasMore: true,
     total: 0,
     currentQuery: ''
   });
   ```
4. Модифицировать функцию `search()` для сброса пагинации при новом поиске
5. Добавить функцию `onLazyLoad()` для подгрузки следующей порции данных

#### В API контроллере table.class.php:

1. Добавить поддержку параметров `limit` и `offset`
2. Возвращать общее количество записей (`total`) для определения окончания данных
3. Обеспечить корректную работу с параметром `where` при пагинации

#### В компоненте PVMultiAutoComplete.vue:

Аналогичные изменения, адаптированные под особенности множественного автокомплита.

## Ожидаемый результат

После реализации:

1. При открытии автокомплита загружается только первые 10 записей
2. При скролле списка автоматически подгружаются следующие 10 записей
3. Виртуальный скроллинг обеспечивает плавную работу с большими списками
4. Сохраняется совместимость с существующими параметрами (where, parent, ids и т.д.)
5. Производительность значительно улучшается при работе с большими наборами данных

## Примечания

- Параметр `itemSize: 38` должен соответствовать реальной высоте элемента списка в пикселях
- Событие `lazy-load` срабатывает только при включенном `lazy: true` в virtualScrollerOptions
- Важно правильно обрабатывать состояние загрузки, чтобы избежать множественных запросов
- Необходимо сохранить текущий поисковый запрос для корректной подгрузки данных

## Файлы для изменения

1. `V:/OSPanel/home/modx28.loc/public/Extras/PVTables/src/components/PVAutoComplete.vue`
2. `V:/OSPanel/home/modx28.loc/public/Extras/PVTables/src/components/PVMultiAutoComplete.vue`
3. `V:/OSPanel/home/modx28.loc/public/Extras/gtsAPI/core/components/gtsapi/api_controllers/table.class.php`
4. Документация в `docs/use_gtsapipackages.md`
