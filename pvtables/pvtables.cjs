"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),Ce=require("primevue/datatable"),U=require("primevue/column"),V=require("primevue/button"),Ue=require("primevue/toolbar"),W=require("primevue/dialog"),T=require("primevue/inputtext"),le=require("primevue/textarea"),A=require("primevue/inputnumber"),ae=require("primevue/inputswitch"),N=require("primevue/api"),oe=require("pvtables/gtsdate"),ne=require("pvtables/gtsautocomplete"),re=require("pvtables/gtsselect"),Ne=require("pvtables/notify"),Oe=require("pvtables/pvtabs"),Pe=require("pvtables/api"),Fe=3,Se=()=>{e.onMounted(()=>{document.addEventListener("keydown",b=>{b.code==="KeyZ"&&b.ctrlKey&&c(),b.code==="KeyY"&&b.ctrlKey&&u()})});const p=e.reactive({undo:[],redo:[]}),v=e.reactive({name:"",details:{}}),m=b=>{p.undo.length===Fe&&p.undo.shift(),p.undo.push(b)};function c(){p.undo.length!==0&&(v.details=p.undo.pop(),v.name="undo",v.details.isNew,p.redo.push(v.details))}function u(){p.redo.length!==0&&(v.details=p.redo.pop(),v.name="redo",v.details.isNew,p.undo.push(v.details))}return{undo:c,redo:u,cacheAction:m,cache:p}},De=(p,v)=>{let m=[];return p.length&&p.forEach(function(c){for(let u in v)switch(u=="id"&&(c[u]=Number(c[u])),v[u].type){case"boolean":c.hasOwnProperty(u)&&(c[u]==="0"?c[u]=!1:c[u]=!0);break;case"number":case"decimal":c[u]=Number(c[u]);break}m.push(c)}),m},Ee={class:"card"},_e={key:0,class:"p-3"},Te={key:1,class:"p-3"},Me={class:"p-field"},qe=["for"],Ie=["id"],Ae={class:"confirmation-content"},Le=e.createElementVNode("i",{class:"pi pi-exclamation-triangle p-mr-3",style:{"font-size":"2rem"}},null,-1),Re={key:0},ze={class:"confirmation-content"},$e=e.createElementVNode("i",{class:"pi pi-exclamation-triangle p-mr-3",style:{"font-size":"2rem"}},null,-1),Ke={key:0},Y={__name:"PVTables",props:{table:{type:String,required:!0},actions:{type:Object,default:{}},reload:{type:Boolean},filters:{type:Object,default:{}}},setup(p,{expose:v}){e.defineComponent({name:"PVTables"});const m=p,c=Pe(m.table),{notify:u}=Ne.useNotifications(),b=e.ref(),Z=()=>{let o={};for(let n in f)if(m.filters.hasOwnProperty(n))o[n]=m.filters[n];else switch(f[n].type){default:o[n]={operator:N.FilterOperator.AND,constraints:[{value:null,matchMode:N.FilterMatchMode.STARTS_WITH}]}}b.value=o},ie=async o=>{h.value.filters=b.value,await C(o)},se=async()=>{Z(),h.value.filters=b.value,await C()},L=o=>"Поиск по "+o.label,R=e.ref(),M=e.ref(!0),z=e.ref(0),J=e.ref(0),h=e.ref({}),q=e.ref([{field:"id",label:"ID"}]);let f={};const k=e.ref();let O=e.ref([]);const I=e.ref(!1),X=e.ref([]),$=e.ref({});e.onMounted(async()=>{M.value=!0,h.value={first:R.value.first,rows:R.value.rows,sortField:null,sortOrder:null};try{const o=await c.options();if(o.data.hasOwnProperty("fields")){f=o.data.fields;let n=[],s=[];for(let l in f)f[l].field=l,f[l].hasOwnProperty("label")||(f[l].label=l),f[l].hasOwnProperty("type")||(f[l].type="text"),f[l].hasOwnProperty("readonly")&&(f[l].readonly===!0||f[l].readonly==1?f[l].readonly=!0:f[l].readonly=!1),s.push(f[l]),n.push(l);X.value=n,Z();let t=o.data.actions;if(m.actions.hasOwnProperty(m.table))for(let l in m.actions[m.table])t[l]=m.actions[m.table][l];for(let l in t){let a={...t[l]},r=!0;switch(a.action=l,l){case"update":a.hasOwnProperty("row")||(a.row=!0),a.hasOwnProperty("icon")||(a.icon="pi pi-pencil"),a.hasOwnProperty("class")||(a.class="p-button-rounded p-button-success"),a.hasOwnProperty("click")||(a.click=y=>fe(y));break;case"delete":a.hasOwnProperty("row")||(a.row=!0),a.hasOwnProperty("head")||(a.head=!0),a.hasOwnProperty("icon")||(a.icon="pi pi-trash"),a.hasOwnProperty("class")||(a.class="p-button-rounded p-button-danger"),a.hasOwnProperty("click")||(a.click=y=>he(y)),a.hasOwnProperty("head_click")||(a.head_click=()=>we()),a.hasOwnProperty("label")||(a.label="Удалить");break;case"create":a.hasOwnProperty("head")||(a.head=!0),a.hasOwnProperty("icon")||(a.icon="pi pi-plus"),a.hasOwnProperty("class")||(a.class="p-button-rounded p-button-success"),a.hasOwnProperty("head_click")||(a.head_click=()=>be()),a.hasOwnProperty("label")||(a.label="Создать");break;case"subtables":r=!1;for(let y in t[l]){let d={action:l,...t[l][y]};d.table=y,d.hasOwnProperty("row")||(d.row=!0),d.hasOwnProperty("icon")||(d.icon="pi pi-angle-right"),d.hasOwnProperty("class")||(d.class="p-button-rounded p-button-success"),d.hasOwnProperty("click")||(d.click=Q=>te(Q,d)),I.value=!0,O.value.push(d)}break;case"subtabs":r=!1;for(let y in t[l]){let d={action:l,tabs:{...t[l][y]}};d.table=y,d.hasOwnProperty("row")||(d.row=!0),d.hasOwnProperty("icon")||(d.icon="pi pi-angle-right"),d.hasOwnProperty("class")||(d.class="p-button-rounded p-button-success"),d.hasOwnProperty("click")||(d.click=Q=>te(Q,d)),I.value=!0,O.value.push(d)}break}r&&(a.hasOwnProperty("row")&&(I.value=!0),O.value.push(a))}o.data.selects&&($.value=o.data.selects),q.value=s}await C()}catch(o){u("error",{detail:o.message},!0)}});const P=e.ref({}),x=e.ref({}),F=e.ref({}),K=o=>{if(!o||o==m.table)C();else if(o&&F.value)for(let n in F.value)F.value[n].refresh(o)};v({refresh:K});const S=e.ref({}),ee=async o=>{P.value={...o}},te=async(o,n)=>{let s={...P.value};if(s.hasOwnProperty(o.id))if(x.value[o.id].table==n.table){delete s[o.id],await ee(s);return}else delete s[o.id],await ee(s),s[o.id]=!0;else s[o.id]=!0;if(x.value[o.id]=n,n.action=="subtables"){if(n.hasOwnProperty("where")){let t={};for(let l in n.where)t[l]={operator:N.FilterOperator.AND,constraints:[{value:o[n.where[l]],matchMode:N.FilterMatchMode.EQUALS}]};S.value[o.id]=t}}else if(n.action=="subtabs"){for(let t in n.tabs)if(n.tabs[t].hasOwnProperty("where")){let l={};for(let a in n.tabs[t].where)l[a]={operator:N.FilterOperator.AND,constraints:[{value:o[n.tabs[t].where[a]],matchMode:N.FilterMatchMode.EQUALS}]};S.value[o.id]={},S.value[o.id][t]=l}}P.value={...s}},j=e.ref({}),C=async o=>{M.value=!0,h.value={...h.value,first:(o==null?void 0:o.first)||J.value};let n={limit:h.value.rows,setTotal:1,offset:h.value.first,multiSortMeta:h.value.multiSortMeta,filters:b.value};try{const s=await c.read(n);if(k.value=De(s.data.rows,f),s.data.autocomplete)for(let t in s.data.autocomplete)j.value[t]=s.data.autocomplete[t];z.value=s.data.total,M.value=!1}catch(s){u("error",{detail:s.message})}},{cacheAction:de,cache:Ge}=Se(),D=async o=>{let{data:n,newValue:s,field:t}=o;const l={id:n.id,[t]:s};de({type:"update",payload:l});try{(await c.update(l)).success&&(n[t]=s)}catch(a){u("error",{detail:a.message},!0)}},ue=async o=>{h.value=o,await C(o)},ce=async o=>{h.value=o,await C(o)},pe=o=>o.toString().replace(".",","),i=e.ref({}),G=e.ref(!1),g=e.ref(!1),fe=o=>{i.value={...o},g.value=!0},me=()=>{g.value=!1,G.value=!1},ye=async()=>{if(G.value=!0,i.value.id)try{await c.update(i.value),k.value[ve(Number(i.value.id))]=i.value,g.value=!1,i.value={}}catch(o){u("error",{detail:o.message})}else try{await c.create(i.value),K(),g.value=!1,i.value={}}catch(o){u("error",{detail:o.message})}},ve=o=>{let n=-1;for(let s=0;s<k.value.length;s++)if(k.value[s].id===o){n=s;break}return n},be=()=>{i.value={},G.value=!1,g.value=!0},E=e.ref(!1),_=e.ref(!1),he=o=>{i.value=o,E.value=!0},ke=async()=>{try{await c.delete({ids:i.value.id}),k.value=k.value.filter(o=>o.id!==i.value.id),E.value=!1,i.value={}}catch(o){u("error",{detail:o.message})}},we=()=>{w.value&&w.value.length&&(_.value=!0)},Ve=async()=>{const o=w.value.map(n=>n.id).join(",");try{await c.delete({ids:o}),k.value=k.value.filter(n=>!w.value.includes(n)),_.value=!1,w.value=null}catch(n){u("error",{detail:n.message})}},w=e.ref(),B=e.ref(!1),ge=o=>{B.value=o.checked,B.value?(B.value=!0,w.value=k.value):(B.value=!1,w.value=[])},Be=()=>{B.value=w.value.length===z.value},xe=()=>{B.value=!1},H=o=>{if(o.readonly)return"readonly"};return(o,n)=>{const s=e.resolveComponent("PVTables",!0);return e.openBlock(),e.createElementBlock("div",Ee,[e.createVNode(e.unref(Ue),{class:"p-mb-4"},{start:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(O).filter(t=>t.head),t=>(e.openBlock(),e.createBlock(e.unref(V),{icon:t.icon,label:t.label,class:e.normalizeClass(t.class),onClick:t.head_click},null,8,["icon","label","class","onClick"]))),256))]),end:e.withCtx(()=>[e.createVNode(e.unref(V),{icon:"pi pi-refresh",class:"p-button-rounded p-button-success",onClick:n[0]||(n[0]=t=>K())}),e.createVNode(e.unref(V),{type:"button",icon:"pi pi-filter-slash",onClick:n[1]||(n[1]=t=>se())})]),_:1}),e.createVNode(e.unref(Ce),{value:k.value,lazy:"",paginator:"",first:J.value,rows:10,rowsPerPageOptions:[10,60,30,10],ref_key:"dt",ref:R,dataKey:"id",totalRecords:z.value,loading:M.value,onPage:n[3]||(n[3]=t=>ue(t)),onSort:n[4]||(n[4]=t=>ce(t)),sortMode:"multiple",editMode:"cell",onCellEditComplete:D,selection:w.value,"onUpdate:selection":n[5]||(n[5]=t=>w.value=t),selectAll:B.value,onSelectAllChange:ge,onRowSelect:Be,onRowUnselect:xe,filters:b.value,"onUpdate:filters":n[6]||(n[6]=t=>b.value=t),filterDisplay:"menu",globalFilterFields:X.value,onFilter:n[7]||(n[7]=t=>ie(t)),expandedRows:P.value,"onUpdate:expandedRows":n[8]||(n[8]=t=>P.value=t),showGridlines:"",scrollable:"",scrollHeight:"45rem",resizableColumns:"",columnResizeMode:"expand"},{expansion:e.withCtx(t=>[x.value[t.data.id].action=="subtables"?(e.openBlock(),e.createElementBlock("div",_e,[e.createVNode(s,{table:x.value[t.data.id].table,actions:p.actions,filters:S.value[t.data.id],ref:l=>{l&&(F.value[t.data.id]=l)}},null,8,["table","actions","filters"])])):e.createCommentVNode("",!0),x.value[t.data.id].action=="subtabs"?(e.openBlock(),e.createElementBlock("div",Te,[e.createVNode(e.unref(Oe),{tabs:x.value[t.data.id].tabs,actions:p.actions,filters:S.value[t.data.id],ref:l=>{l&&(F.value[t.data.id]=l)}},null,8,["tabs","actions","filters"])])):e.createCommentVNode("",!0)]),default:e.withCtx(()=>[e.createVNode(e.unref(U),{selectionMode:"multiple",headerStyle:"width: 3rem"}),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(q.value.filter(t=>t.modal_only!=!0),t=>(e.openBlock(),e.createElementBlock(e.Fragment,{key:t.field},[t.field=="id"?(e.openBlock(),e.createBlock(e.unref(U),{key:0,field:"id",header:"id",style:{padding:"1rem 10px 1rem 10px"},sortable:""},{body:e.withCtx(({data:l,field:a})=>[e.createTextVNode(e.toDisplayString(l[a]),1)]),_:1})):t.type=="autocomplete"?(e.openBlock(),e.createBlock(e.unref(U),{key:1,field:t.field,header:t.label,class:e.normalizeClass(H(t)),style:{"min-width":"350px"},sortable:""},{body:e.withCtx(({data:l,field:a})=>{var r;return[e.createVNode(e.unref(ne),{table:t.table,id:l[a],"onUpdate:id":y=>l[a]=y,options:(r=j.value[a])==null?void 0:r.rows,onSetValue:y=>D({data:l,field:a,newValue:l[a]}),disabled:t.readonly},null,8,["table","id","onUpdate:id","options","onSetValue","disabled"])]}),filter:e.withCtx(({filterModel:l})=>[e.createVNode(e.unref(T),{modelValue:l.value,"onUpdate:modelValue":a=>l.value=a,type:"text",class:"p-column-filter",placeholder:L(t)},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["field","header","class"])):t.type=="select"?(e.openBlock(),e.createBlock(e.unref(U),{key:2,field:t.field,header:t.label,class:e.normalizeClass(H(t)),style:{"min-width":"350px"},sortable:""},{body:e.withCtx(({data:l,field:a})=>{var r;return[e.createVNode(e.unref(re),{id:l[a],"onUpdate:id":y=>l[a]=y,options:(r=$.value[a])==null?void 0:r.rows,onSetValue:y=>D({data:l,field:a,newValue:l[a]}),disabled:t.readonly},null,8,["id","onUpdate:id","options","onSetValue","disabled"])]}),filter:e.withCtx(({filterModel:l})=>[e.createVNode(e.unref(T),{modelValue:l.value,"onUpdate:modelValue":a=>l.value=a,type:"text",class:"p-column-filter",placeholder:L(t)},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["field","header","class"])):(e.openBlock(),e.createBlock(e.unref(U),{key:3,field:t.field,header:t.label,class:e.normalizeClass(H(t)),style:{"min-width":"350px"},sortable:""},e.createSlots({body:e.withCtx(({data:l,field:a})=>[t.type=="decimal"?(e.openBlock(),e.createElementBlock(e.Fragment,{key:0},[e.createTextVNode(e.toDisplayString(pe(l[a])),1)],64)):t.type=="boolean"?(e.openBlock(),e.createBlock(e.unref(ae),{key:1,modelValue:l[a],"onUpdate:modelValue":r=>l[a]=r,onKeydown:n[2]||(n[2]=e.withKeys(e.withModifiers(()=>{},["stop"]),["tab"])),onChange:r=>D({data:l,field:a,newValue:l[a]}),disabled:t.readonly},null,8,["modelValue","onUpdate:modelValue","onChange","disabled"])):t.type==="date"?(e.openBlock(),e.createBlock(e.unref(oe),{key:2,"model-value":l[a],"onUpdate:modelValue":r=>D({data:l,field:a,newValue:r}),disabled:t.readonly},null,8,["model-value","onUpdate:modelValue","disabled"])):(e.openBlock(),e.createElementBlock(e.Fragment,{key:3},[e.createTextVNode(e.toDisplayString(l[a]),1)],64))]),filter:e.withCtx(({filterModel:l})=>[e.createVNode(e.unref(T),{modelValue:l.value,"onUpdate:modelValue":a=>l.value=a,type:"text",class:"p-column-filter",placeholder:L(t)},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},[!["boolean","date"].includes(t.type)&&!t.readonly?{name:"editor",fn:e.withCtx(({data:l,field:a})=>[t.type=="textarea"?(e.openBlock(),e.createBlock(e.unref(le),{key:0,modelValue:l[a],"onUpdate:modelValue":r=>l[a]=r,rows:"1"},null,8,["modelValue","onUpdate:modelValue"])):t.type=="number"?(e.openBlock(),e.createBlock(e.unref(A),{key:1,modelValue:l[a],"onUpdate:modelValue":r=>l[a]=r},null,8,["modelValue","onUpdate:modelValue"])):t.type=="decimal"?(e.openBlock(),e.createBlock(e.unref(A),{key:2,modelValue:l[a],"onUpdate:modelValue":r=>l[a]=r,minFractionDigits:t.FractionDigits,maxFractionDigits:t.FractionDigits},null,8,["modelValue","onUpdate:modelValue","minFractionDigits","maxFractionDigits"])):(e.openBlock(),e.createBlock(e.unref(T),{key:3,modelValue:l[a],"onUpdate:modelValue":r=>l[a]=r},null,8,["modelValue","onUpdate:modelValue"]))]),key:"0"}:void 0]),1032,["field","header","class"]))],64))),128)),I.value?(e.openBlock(),e.createBlock(e.unref(U),{key:0,exportable:!1,style:{"white-space":"nowrap"}},{body:e.withCtx(t=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(O).filter(l=>l.row),l=>(e.openBlock(),e.createBlock(e.unref(V),{icon:l.icon,class:e.normalizeClass(l.class),onClick:a=>l.click(t.data,q.value)},null,8,["icon","class","onClick"]))),256))]),_:1})):e.createCommentVNode("",!0)]),_:1},8,["value","first","totalRecords","loading","selection","selectAll","filters","globalFilterFields","expandedRows"]),e.createVNode(e.unref(W),{visible:g.value,"onUpdate:visible":n[9]||(n[9]=t=>g.value=t),style:{width:"450px"},header:"Редактировать",modal:!0,class:"p-fluid"},{footer:e.withCtx(()=>[e.createVNode(e.unref(V),{label:"Отмена",icon:"pi pi-times",class:"p-button-text",onClick:me}),e.createVNode(e.unref(V),{label:"Сохранить",icon:"pi pi-check",class:"p-button-text",onClick:ye})]),default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(q.value.filter(t=>t.table_only!=!0),t=>{var l,a;return e.openBlock(),e.createElementBlock("div",Me,[e.createElementVNode("label",{for:t.field},e.toDisplayString(t.label),9,qe),t.field=="id"?(e.openBlock(),e.createElementBlock("p",{key:0,id:t.field},e.toDisplayString(i.value[t.field]),9,Ie)):t.type=="textarea"?(e.openBlock(),e.createBlock(e.unref(le),{key:1,id:t.field,modelValue:i.value[t.field],"onUpdate:modelValue":r=>i.value[t.field]=r,modelModifiers:{trim:!0},disabled:t.readonly},null,8,["id","modelValue","onUpdate:modelValue","disabled"])):t.type=="number"?(e.openBlock(),e.createBlock(e.unref(A),{key:2,id:t.field,modelValue:i.value[t.field],"onUpdate:modelValue":r=>i.value[t.field]=r,disabled:t.readonly},null,8,["id","modelValue","onUpdate:modelValue","disabled"])):t.type=="autocomplete"?(e.openBlock(),e.createBlock(e.unref(ne),{key:3,id:i.value[t.field],"onUpdate:id":r=>i.value[t.field]=r,table:t.table,options:(l=j.value[t.field])==null?void 0:l.rows,disabled:t.readonly},null,8,["id","onUpdate:id","table","options","disabled"])):t.type=="select"?(e.openBlock(),e.createBlock(e.unref(re),{key:4,id:i.value[t.field],"onUpdate:id":r=>i.value[t.field]=r,options:(a=$.value[t.field])==null?void 0:a.rows,disabled:t.readonly},null,8,["id","onUpdate:id","options","disabled"])):t.type=="decimal"?(e.openBlock(),e.createBlock(e.unref(A),{key:5,id:t.field,modelValue:i.value[t.field],"onUpdate:modelValue":r=>i.value[t.field]=r,minFractionDigits:t.FractionDigits,maxFractionDigits:t.FractionDigits,disabled:t.readonly},null,8,["id","modelValue","onUpdate:modelValue","minFractionDigits","maxFractionDigits","disabled"])):t.type=="boolean"?(e.openBlock(),e.createBlock(e.unref(ae),{key:6,id:t.field,modelValue:i.value[t.field],"onUpdate:modelValue":r=>i.value[t.field]=r,disabled:t.readonly},null,8,["id","modelValue","onUpdate:modelValue","disabled"])):t.type==="date"?(e.openBlock(),e.createBlock(e.unref(oe),{key:7,modelValue:i.value[t.field],"onUpdate:modelValue":r=>i.value[t.field]=r,disabled:t.readonly},null,8,["modelValue","onUpdate:modelValue","disabled"])):(e.openBlock(),e.createBlock(e.unref(T),{key:8,id:t.field,modelValue:i.value[t.field],"onUpdate:modelValue":r=>i.value[t.field]=r,modelModifiers:{trim:!0},disabled:t.readonly},null,8,["id","modelValue","onUpdate:modelValue","disabled"]))])}),256))]),_:1},8,["visible"]),e.createVNode(e.unref(W),{visible:E.value,"onUpdate:visible":n[11]||(n[11]=t=>E.value=t),style:{width:"450px"},header:"Confirm",modal:!0},{footer:e.withCtx(()=>[e.createVNode(e.unref(V),{label:"Нет",icon:"pi pi-times",class:"p-button-text",onClick:n[10]||(n[10]=t=>E.value=!1)}),e.createVNode(e.unref(V),{label:"Да",icon:"pi pi-check",class:"p-button-text",onClick:ke})]),default:e.withCtx(()=>[e.createElementVNode("div",Ae,[Le,i.value?(e.openBlock(),e.createElementBlock("span",Re,"Вы хотите удалить эту запись?")):e.createCommentVNode("",!0)])]),_:1},8,["visible"]),e.createVNode(e.unref(W),{visible:_.value,"onUpdate:visible":n[13]||(n[13]=t=>_.value=t),style:{width:"450px"},header:"Confirm",modal:!0},{footer:e.withCtx(()=>[e.createVNode(e.unref(V),{label:"Нет",icon:"pi pi-times",class:"p-button-text",onClick:n[12]||(n[12]=t=>_.value=!1)}),e.createVNode(e.unref(V),{label:"Да",icon:"pi pi-check",class:"p-button-text",onClick:Ve})]),default:e.withCtx(()=>[e.createElementVNode("div",ze,[$e,i.value?(e.openBlock(),e.createElementBlock("span",Ke,"Вы хотите удалить отмеченные записи?")):e.createCommentVNode("",!0)])]),_:1},8,["visible"])])}}},je={install:(p,v)=>{p.component(Y.name,Y)}};exports.PVTables=Y;exports.default=je;
