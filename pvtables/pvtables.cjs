"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),ge=require("primevue/datatable"),O=require("primevue/column"),b=require("primevue/button"),Be=require("primevue/toolbar"),R=require("primevue/dialog"),$=require("primevue/inputtext"),Y=require("primevue/textarea"),_=require("primevue/inputnumber"),Z=require("primevue/inputswitch"),E=require("primevue/api"),J=require("pvtables/gtsdate"),X=require("pvtables/gtsautocomplete"),xe=require("pvtables/notify"),Ce=require("pvtables/api"),Pe=3,Ne=()=>{e.onMounted(()=>{document.addEventListener("keydown",f=>{f.code==="KeyZ"&&f.ctrlKey&&u(),f.code==="KeyY"&&f.ctrlKey&&s()})});const c=e.reactive({undo:[],redo:[]}),p=e.reactive({name:"",details:{}}),y=f=>{c.undo.length===Pe&&c.undo.shift(),c.undo.push(f)};function u(){c.undo.length!==0&&(p.details=c.undo.pop(),p.name="undo",p.details.isNew,c.redo.push(p.details))}function s(){c.redo.length!==0&&(p.details=c.redo.pop(),p.name="redo",p.details.isNew,c.undo.push(p.details))}return{undo:u,redo:s,cacheAction:y,cache:c}},Ue=(c,p)=>{let y=[];return c.length&&c.forEach(function(u){for(let s in p)switch(s=="id"&&(u[s]=Number(u[s])),p[s].type){case"boolean":u.hasOwnProperty(s)&&(u[s]==="0"?u[s]=!1:u[s]=!0);break;case"number":case"decimal":u[s]=Number(u[s]);break}y.push(u)}),y},Oe={class:"card"},Fe={class:"p-3"},De={class:"p-field"},Se=["for"],_e=["id"],Ee={class:"confirmation-content"},Te=e.createElementVNode("i",{class:"pi pi-exclamation-triangle p-mr-3",style:{"font-size":"2rem"}},null,-1),Ie={key:0},Me={class:"confirmation-content"},qe=e.createElementVNode("i",{class:"pi pi-exclamation-triangle p-mr-3",style:{"font-size":"2rem"}},null,-1),Ae={key:0},z={__name:"PVTables",props:{table:{type:String,required:!0},actions:{type:Object},reload:{type:Boolean},filters:{type:Object,default:{}}},setup(c,{expose:p}){e.defineComponent({name:"PVTables"});const y=c,u=Ce(y.table),{notify:s}=xe.useNotifications(),f=e.ref(),K=()=>{let o={};for(let n in m)if(y.filters.hasOwnProperty(n))o[n]=y.filters[n];else switch(m[n].type){default:o[n]={operator:E.FilterOperator.AND,constraints:[{value:null,matchMode:E.FilterMatchMode.STARTS_WITH}]}}f.value=o},ee=async o=>{k.value.filters=f.value,await x(o)},te=async()=>{K(),k.value.filters=f.value,await x()},le=o=>"Поиск по "+o.label,T=e.ref(),C=e.ref(!0),I=e.ref(0),j=e.ref(0),k=e.ref({}),F=e.ref([{field:"id",label:"ID"}]);let m={};const h=e.ref();let D=e.ref([]);const M=e.ref(!1),ae=e.ref(!1),G=e.ref([]);e.onMounted(async()=>{C.value=!0,k.value={first:T.value.first,rows:T.value.rows,sortField:null,sortOrder:null};try{const o=await u.options();if(o.data.hasOwnProperty("fields")){m=o.data.fields;let n=[],i=[];for(let a in m)m[a].field=a,m[a].hasOwnProperty("label")||(m[a].label=a),m[a].hasOwnProperty("type")||(m[a].type="text"),i.push(m[a]),n.push(a);G.value=n,K();let t=o.data.actions;for(let a in y.actions)t[a]=y.actions[a];for(let a in t){let l={...t[a]},d=!0;switch(l.action=a,a){case"update":l.hasOwnProperty("row")||(l.row=!0),l.hasOwnProperty("icon")||(l.icon="pi pi-pencil"),l.hasOwnProperty("class")||(l.class="p-button-rounded p-button-success"),l.hasOwnProperty("click")||(l.click=V=>ue(V));break;case"delete":l.hasOwnProperty("row")||(l.row=!0),l.hasOwnProperty("head")||(l.head=!0),l.hasOwnProperty("icon")||(l.icon="pi pi-trash"),l.hasOwnProperty("class")||(l.class="p-button-rounded p-button-danger"),l.hasOwnProperty("click")||(l.click=V=>me(V)),l.hasOwnProperty("head_click")||(l.head_click=()=>ye()),l.hasOwnProperty("label")||(l.label="Удалить");break;case"create":l.hasOwnProperty("head")||(l.head=!0),l.hasOwnProperty("icon")||(l.icon="pi pi-plus"),l.hasOwnProperty("class")||(l.class="p-button-rounded p-button-success"),l.hasOwnProperty("head_click")||(l.head_click=()=>fe()),l.hasOwnProperty("label")||(l.label="Создать");break;case"subtables":d=!1;for(let V in t[a]){let v={...t[a][V]};v.table=V,v.hasOwnProperty("row")||(v.row=!0),v.hasOwnProperty("icon")||(v.icon="pi pi-angle-right"),v.hasOwnProperty("class")||(v.class="p-button-rounded p-button-success"),v.hasOwnProperty("click")||(v.click=Ve=>oe(Ve,v)),M.value=!0,D.value.push(v)}break}d&&(l.hasOwnProperty("row")&&(M.value=!0),l.hasOwnProperty("row")&&(ae.value=!0),D.value.push(l))}F.value=i}await x()}catch(o){s("error",{detail:o.message},!0)}});const P=e.ref({}),q=e.ref({}),H=e.ref({}),Q=async o=>{P.value={...o}},oe=async(o,n)=>{let i={...P.value};if(i.hasOwnProperty(o.id))if(q.value[o.id]==n.table){delete i[o.id],await Q(i);return}else delete i[o.id],await Q(i),i[o.id]=!0;else i[o.id]=!0;if(q.value[o.id]=n.table,n.hasOwnProperty("where")){let t={};for(let a in n.where)t[a]={operator:E.FilterOperator.AND,constraints:[{value:o[n.where[a]],matchMode:E.FilterMatchMode.EQUALS}]};H.value[o.id]=t}P.value={...i}},A=e.ref({}),x=async o=>{C.value=!0,k.value={...k.value,first:(o==null?void 0:o.first)||j.value};let n={limit:k.value.rows,setTotal:1,offset:k.value.first,multiSortMeta:k.value.multiSortMeta,filters:f.value};try{const i=await u.read(n);h.value=Ue(i.data.rows,m),A.value=i.data.autocomplete,I.value=i.data.total,C.value=!1}catch(i){s("error",{detail:i.message})}},W=()=>{x()};p({refresh:W});const{cacheAction:ne,cache:Re}=Ne(),S=async o=>{let{data:n,newValue:i,field:t}=o;const a={id:n.id,[t]:i};ne({type:"update",payload:a});try{(await u.update(a)).success&&(n[t]=i)}catch(l){o.preventDefault(),s("error",{detail:l.message},!0)}},re=async o=>{k.value=o,await x(o)},ie=async o=>{k.value=o,await x(o)},se=o=>o.toString().replace(".",","),r=e.ref({}),L=e.ref(!1),g=e.ref(!1),ue=o=>{r.value={...o},g.value=!0},de=()=>{g.value=!1,L.value=!1},ce=async()=>{if(L.value=!0,r.value.id)try{await u.update(r.value),h.value[pe(Number(r.value.id))]=r.value,g.value=!1,r.value={}}catch(o){s("error",{detail:o.message})}else try{await u.create(),C.value=!0,g.value=!1,r.value={}}catch(o){s("error",{detail:o.message})}},pe=o=>{let n=-1;for(let i=0;i<h.value.length;i++)if(h.value[i].id===o){n=i;break}return n},fe=()=>{r.value={},L.value=!1,g.value=!0},N=e.ref(!1),U=e.ref(!1),me=o=>{r.value=o,N.value=!0},ve=async()=>{try{await u.delete({ids:r.value.id}),h.value=h.value.filter(o=>o.id!==r.value.id),N.value=!1,r.value={}}catch(o){s("error",{detail:o.message})}},ye=()=>{w.value&&w.value.length&&(U.value=!0)},ke=async()=>{const o=w.value.map(n=>n.id).join(",");try{await u.delete({ids:o}),h.value=h.value.filter(n=>!w.value.includes(n)),U.value=!1,w.value=null}catch(n){s("error",{detail:n.message})}},w=e.ref(),B=e.ref(!1),he=o=>{B.value=o.checked,B.value?(B.value=!0,w.value=h.value):(B.value=!1,w.value=[])},we=()=>{B.value=w.value.length===I.value},be=()=>{B.value=!1};return(o,n)=>{const i=e.resolveComponent("PVTables",!0);return e.openBlock(),e.createElementBlock("div",Oe,[e.createVNode(e.unref(Be),{class:"p-mb-4"},{start:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(D).filter(t=>t.head),t=>(e.openBlock(),e.createBlock(e.unref(b),{icon:t.icon,label:t.label,class:e.normalizeClass(t.class),onClick:t.head_click},null,8,["icon","label","class","onClick"]))),256))]),end:e.withCtx(()=>[e.createVNode(e.unref(b),{icon:"pi pi-refresh",class:"p-button-rounded p-button-success",onClick:W}),e.createVNode(e.unref(b),{type:"button",icon:"pi pi-filter-slash",onClick:n[0]||(n[0]=t=>te())})]),_:1}),e.createVNode(e.unref(ge),{value:h.value,lazy:"",paginator:"",first:j.value,rows:10,rowsPerPageOptions:[10,60,30,10],ref_key:"dt",ref:T,dataKey:"id",totalRecords:I.value,loading:C.value,onPage:n[2]||(n[2]=t=>re(t)),onSort:n[3]||(n[3]=t=>ie(t)),sortMode:"multiple",editMode:"cell",onCellEditComplete:S,selection:w.value,"onUpdate:selection":n[4]||(n[4]=t=>w.value=t),selectAll:B.value,onSelectAllChange:he,onRowSelect:we,onRowUnselect:be,filters:f.value,"onUpdate:filters":n[5]||(n[5]=t=>f.value=t),filterDisplay:"menu",globalFilterFields:G.value,onFilter:n[6]||(n[6]=t=>ee(t)),expandedRows:P.value,"onUpdate:expandedRows":n[7]||(n[7]=t=>P.value=t),showGridlines:""},{expansion:e.withCtx(t=>[e.createElementVNode("div",Fe,[e.createVNode(i,{table:q.value[t.data.id],filters:H.value[t.data.id]},null,8,["table","filters"])])]),default:e.withCtx(()=>[e.createVNode(e.unref(O),{selectionMode:"multiple",headerStyle:"width: 3rem"}),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(F.value.filter(t=>t.modal_only!=!0),t=>(e.openBlock(),e.createElementBlock(e.Fragment,{key:t.field},[t.field=="id"?(e.openBlock(),e.createBlock(e.unref(O),{key:0,field:"id",header:"id",style:{padding:"1rem 10px 1rem 10px"},sortable:""},{body:e.withCtx(({data:a,field:l})=>[e.createTextVNode(e.toDisplayString(a[l]),1)]),_:1})):t.type=="autocomplete"?(e.openBlock(),e.createBlock(e.unref(O),{key:1,field:t.field,header:t.label,style:{"min-width":"350px"}},{body:e.withCtx(({data:a,field:l})=>{var d;return[e.createVNode(e.unref(X),{table:t.table,id:a[l],"onUpdate:id":V=>a[l]=V,options:(d=A.value[l])==null?void 0:d.rows,onSetValue:V=>S({data:a,field:l,newValue:a[l]})},null,8,["table","id","onUpdate:id","options","onSetValue"])]}),_:2},1032,["field","header"])):(e.openBlock(),e.createBlock(e.unref(O),{key:2,field:t.field,header:t.label,style:{"min-width":"12rem"},sortable:""},e.createSlots({body:e.withCtx(({data:a,field:l})=>[t.type=="decimal"?(e.openBlock(),e.createElementBlock(e.Fragment,{key:0},[e.createTextVNode(e.toDisplayString(se(a[l])),1)],64)):t.type=="boolean"?(e.openBlock(),e.createBlock(e.unref(Z),{key:1,modelValue:a[l],"onUpdate:modelValue":d=>a[l]=d,onKeydown:n[1]||(n[1]=e.withKeys(e.withModifiers(()=>{},["stop"]),["tab"])),onChange:d=>S({data:a,field:l,newValue:a[l]})},null,8,["modelValue","onUpdate:modelValue","onChange"])):t.type==="date"?(e.openBlock(),e.createBlock(e.unref(J),{key:2,"model-value":a[l],"onUpdate:modelValue":d=>S({data:a,field:l,newValue:d})},null,8,["model-value","onUpdate:modelValue"])):(e.openBlock(),e.createElementBlock(e.Fragment,{key:3},[e.createTextVNode(e.toDisplayString(a[l]),1)],64))]),filter:e.withCtx(({filterModel:a})=>[e.createVNode(e.unref($),{modelValue:a.value,"onUpdate:modelValue":l=>a.value=l,type:"text",class:"p-column-filter",placeholder:le(t)},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},[["boolean","date"].includes(t.type)?void 0:{name:"editor",fn:e.withCtx(({data:a,field:l})=>[t.type=="textarea"?(e.openBlock(),e.createBlock(e.unref(Y),{key:0,modelValue:a[l],"onUpdate:modelValue":d=>a[l]=d,rows:"1"},null,8,["modelValue","onUpdate:modelValue"])):t.type=="number"?(e.openBlock(),e.createBlock(e.unref(_),{key:1,modelValue:a[l],"onUpdate:modelValue":d=>a[l]=d},null,8,["modelValue","onUpdate:modelValue"])):t.type=="decimal"?(e.openBlock(),e.createBlock(e.unref(_),{key:2,modelValue:a[l],"onUpdate:modelValue":d=>a[l]=d,minFractionDigits:t.FractionDigits,maxFractionDigits:t.FractionDigits},null,8,["modelValue","onUpdate:modelValue","minFractionDigits","maxFractionDigits"])):(e.openBlock(),e.createBlock(e.unref($),{key:3,modelValue:a[l],"onUpdate:modelValue":d=>a[l]=d},null,8,["modelValue","onUpdate:modelValue"]))]),key:"0"}]),1032,["field","header"]))],64))),128)),M.value?(e.openBlock(),e.createBlock(e.unref(O),{key:0,exportable:!1,style:{"white-space":"nowrap"}},{body:e.withCtx(t=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(D).filter(a=>a.row),a=>(e.openBlock(),e.createBlock(e.unref(b),{icon:a.icon,class:e.normalizeClass(a.class),onClick:l=>a.click(t.data,F.value)},null,8,["icon","class","onClick"]))),256))]),_:1})):e.createCommentVNode("",!0)]),_:1},8,["value","first","totalRecords","loading","selection","selectAll","filters","globalFilterFields","expandedRows"]),e.createVNode(e.unref(R),{visible:g.value,"onUpdate:visible":n[8]||(n[8]=t=>g.value=t),style:{width:"450px"},header:"Редактировать",modal:!0,class:"p-fluid"},{footer:e.withCtx(()=>[e.createVNode(e.unref(b),{label:"Отмена",icon:"pi pi-times",class:"p-button-text",onClick:de}),e.createVNode(e.unref(b),{label:"Сохранить",icon:"pi pi-check",class:"p-button-text",onClick:ce})]),default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(F.value.filter(t=>t.table_only!=!0),t=>{var a;return e.openBlock(),e.createElementBlock("div",De,[e.createElementVNode("label",{for:t.field},e.toDisplayString(t.label),9,Se),t.field=="id"?(e.openBlock(),e.createElementBlock("p",{key:0,id:t.field},e.toDisplayString(r.value[t.field]),9,_e)):t.type=="textarea"?(e.openBlock(),e.createBlock(e.unref(Y),{key:1,id:t.field,modelValue:r.value[t.field],"onUpdate:modelValue":l=>r.value[t.field]=l,modelModifiers:{trim:!0}},null,8,["id","modelValue","onUpdate:modelValue"])):t.type=="number"?(e.openBlock(),e.createBlock(e.unref(_),{key:2,id:t.field,modelValue:r.value[t.field],"onUpdate:modelValue":l=>r.value[t.field]=l},null,8,["id","modelValue","onUpdate:modelValue"])):t.type=="autocomplete"?(e.openBlock(),e.createBlock(e.unref(X),{key:3,id:r.value[t.field],"onUpdate:id":l=>r.value[t.field]=l,table:t.table,options:(a=A.value[t.field])==null?void 0:a.rows},null,8,["id","onUpdate:id","table","options"])):t.type=="decimal"?(e.openBlock(),e.createBlock(e.unref(_),{key:4,id:t.field,modelValue:r.value[t.field],"onUpdate:modelValue":l=>r.value[t.field]=l,minFractionDigits:t.FractionDigits,maxFractionDigits:t.FractionDigits},null,8,["id","modelValue","onUpdate:modelValue","minFractionDigits","maxFractionDigits"])):t.type=="boolean"?(e.openBlock(),e.createBlock(e.unref(Z),{key:5,id:t.field,modelValue:r.value[t.field],"onUpdate:modelValue":l=>r.value[t.field]=l},null,8,["id","modelValue","onUpdate:modelValue"])):t.type==="date"?(e.openBlock(),e.createBlock(e.unref(J),{key:6,modelValue:r.value[t.field],"onUpdate:modelValue":l=>r.value[t.field]=l},null,8,["modelValue","onUpdate:modelValue"])):(e.openBlock(),e.createBlock(e.unref($),{key:7,id:t.field,modelValue:r.value[t.field],"onUpdate:modelValue":l=>r.value[t.field]=l,modelModifiers:{trim:!0}},null,8,["id","modelValue","onUpdate:modelValue"]))])}),256))]),_:1},8,["visible"]),e.createVNode(e.unref(R),{visible:N.value,"onUpdate:visible":n[10]||(n[10]=t=>N.value=t),style:{width:"450px"},header:"Confirm",modal:!0},{footer:e.withCtx(()=>[e.createVNode(e.unref(b),{label:"Нет",icon:"pi pi-times",class:"p-button-text",onClick:n[9]||(n[9]=t=>N.value=!1)}),e.createVNode(e.unref(b),{label:"Да",icon:"pi pi-check",class:"p-button-text",onClick:ve})]),default:e.withCtx(()=>[e.createElementVNode("div",Ee,[Te,r.value?(e.openBlock(),e.createElementBlock("span",Ie,"Вы хотите удалить эту запись?")):e.createCommentVNode("",!0)])]),_:1},8,["visible"]),e.createVNode(e.unref(R),{visible:U.value,"onUpdate:visible":n[12]||(n[12]=t=>U.value=t),style:{width:"450px"},header:"Confirm",modal:!0},{footer:e.withCtx(()=>[e.createVNode(e.unref(b),{label:"Нет",icon:"pi pi-times",class:"p-button-text",onClick:n[11]||(n[11]=t=>U.value=!1)}),e.createVNode(e.unref(b),{label:"Да",icon:"pi pi-check",class:"p-button-text",onClick:ke})]),default:e.withCtx(()=>[e.createElementVNode("div",Me,[qe,r.value?(e.openBlock(),e.createElementBlock("span",Ae,"Вы хотите удалить отмеченные записи?")):e.createCommentVNode("",!0)])]),_:1},8,["visible"])])}}},Le={install:(c,p)=>{c.component(z.name,z)}};exports.PVTables=z;exports.default=Le;
