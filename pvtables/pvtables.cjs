"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const e=require("vue"),Ce=require("primevue/datatable"),C=require("primevue/column"),V=require("primevue/button"),Ue=require("primevue/toolbar"),G=require("primevue/dialog"),S=require("primevue/inputtext"),X=require("primevue/textarea"),E=require("primevue/inputnumber"),ee=require("primevue/inputswitch"),T=require("primevue/api"),le=require("pvtables/gtsdate"),te=require("pvtables/gtsautocomplete"),ae=require("pvtables/gtsselect"),Ne=require("pvtables/notify"),Pe=require("pvtables/api"),Oe=3,Se=()=>{e.onMounted(()=>{document.addEventListener("keydown",m=>{m.code==="KeyZ"&&m.ctrlKey&&u(),m.code==="KeyY"&&m.ctrlKey&&d()})});const c=e.reactive({undo:[],redo:[]}),f=e.reactive({name:"",details:{}}),b=m=>{c.undo.length===Oe&&c.undo.shift(),c.undo.push(m)};function u(){c.undo.length!==0&&(f.details=c.undo.pop(),f.name="undo",f.details.isNew,c.redo.push(f.details))}function d(){c.redo.length!==0&&(f.details=c.redo.pop(),f.name="redo",f.details.isNew,c.undo.push(f.details))}return{undo:u,redo:d,cacheAction:b,cache:c}},Fe=(c,f)=>{let b=[];return c.length&&c.forEach(function(u){for(let d in f)switch(d=="id"&&(u[d]=Number(u[d])),f[d].type){case"boolean":u.hasOwnProperty(d)&&(u[d]==="0"?u[d]=!1:u[d]=!0);break;case"number":case"decimal":u[d]=Number(u[d]);break}b.push(u)}),b},De={class:"card"},_e={class:"p-3"},Ee={class:"p-field"},Te=["for"],Ie=["id"],qe={class:"confirmation-content"},Me=e.createElementVNode("i",{class:"pi pi-exclamation-triangle p-mr-3",style:{"font-size":"2rem"}},null,-1),Ae={key:0},Le={class:"confirmation-content"},Re=e.createElementVNode("i",{class:"pi pi-exclamation-triangle p-mr-3",style:{"font-size":"2rem"}},null,-1),ze={key:0},H={__name:"PVTables",props:{table:{type:String,required:!0},actions:{type:Object},reload:{type:Boolean},filters:{type:Object,default:{}}},setup(c,{expose:f}){e.defineComponent({name:"PVTables"});const b=c,u=Pe(b.table),{notify:d}=Ne.useNotifications(),m=e.ref(),Q=()=>{let o={};for(let n in p)if(b.filters.hasOwnProperty(n))o[n]=b.filters[n];else switch(p[n].type){default:o[n]={operator:T.FilterOperator.AND,constraints:[{value:null,matchMode:T.FilterMatchMode.STARTS_WITH}]}}m.value=o},oe=async o=>{h.value.filters=m.value,await x(o)},ne=async()=>{Q(),h.value.filters=m.value,await x()},I=o=>"Поиск по "+o.label,q=e.ref(),F=e.ref(!0),M=e.ref(0),W=e.ref(0),h=e.ref({}),D=e.ref([{field:"id",label:"ID"}]);let p={};const k=e.ref();let _=e.ref([]);const A=e.ref(!1),re=e.ref(!1),Y=e.ref([]),L=e.ref({});e.onMounted(async()=>{F.value=!0,h.value={first:q.value.first,rows:q.value.rows,sortField:null,sortOrder:null};try{const o=await u.options();if(o.data.hasOwnProperty("fields")){p=o.data.fields;let n=[],s=[];for(let a in p)p[a].field=a,p[a].hasOwnProperty("label")||(p[a].label=a),p[a].hasOwnProperty("type")||(p[a].type="text"),p[a].hasOwnProperty("readonly")&&(p[a].readonly===!0||p[a].readonly==1?p[a].readonly=!0:p[a].readonly=!1),s.push(p[a]),n.push(a);Y.value=n,Q();let l=o.data.actions;for(let a in b.actions)l[a]=b.actions[a];for(let a in l){let t={...l[a]},r=!0;switch(t.action=a,a){case"update":t.hasOwnProperty("row")||(t.row=!0),t.hasOwnProperty("icon")||(t.icon="pi pi-pencil"),t.hasOwnProperty("class")||(t.class="p-button-rounded p-button-success"),t.hasOwnProperty("click")||(t.click=y=>pe(y));break;case"delete":t.hasOwnProperty("row")||(t.row=!0),t.hasOwnProperty("head")||(t.head=!0),t.hasOwnProperty("icon")||(t.icon="pi pi-trash"),t.hasOwnProperty("class")||(t.class="p-button-rounded p-button-danger"),t.hasOwnProperty("click")||(t.click=y=>be(y)),t.hasOwnProperty("head_click")||(t.head_click=()=>ke()),t.hasOwnProperty("label")||(t.label="Удалить");break;case"create":t.hasOwnProperty("head")||(t.head=!0),t.hasOwnProperty("icon")||(t.icon="pi pi-plus"),t.hasOwnProperty("class")||(t.class="p-button-rounded p-button-success"),t.hasOwnProperty("head_click")||(t.head_click=()=>ve()),t.hasOwnProperty("label")||(t.label="Создать");break;case"subtables":r=!1;for(let y in l[a]){let v={...l[a][y]};v.table=y,v.hasOwnProperty("row")||(v.row=!0),v.hasOwnProperty("icon")||(v.icon="pi pi-angle-right"),v.hasOwnProperty("class")||(v.class="p-button-rounded p-button-success"),v.hasOwnProperty("click")||(v.click=xe=>ie(xe,v)),A.value=!0,_.value.push(v)}break}r&&(t.hasOwnProperty("row")&&(A.value=!0),t.hasOwnProperty("row")&&(re.value=!0),_.value.push(t))}o.data.selects&&(L.value=o.data.selects),D.value=s}await x()}catch(o){d("error",{detail:o.message},!0)}});const U=e.ref({}),R=e.ref({}),Z=e.ref({}),J=async o=>{U.value={...o}},ie=async(o,n)=>{let s={...U.value};if(s.hasOwnProperty(o.id))if(R.value[o.id]==n.table){delete s[o.id],await J(s);return}else delete s[o.id],await J(s),s[o.id]=!0;else s[o.id]=!0;if(R.value[o.id]=n.table,n.hasOwnProperty("where")){let l={};for(let a in n.where)l[a]={operator:T.FilterOperator.AND,constraints:[{value:o[n.where[a]],matchMode:T.FilterMatchMode.EQUALS}]};Z.value[o.id]=l}U.value={...s}},z=e.ref({}),x=async o=>{F.value=!0,h.value={...h.value,first:(o==null?void 0:o.first)||W.value};let n={limit:h.value.rows,setTotal:1,offset:h.value.first,multiSortMeta:h.value.multiSortMeta,filters:m.value};try{const s=await u.read(n);if(k.value=Fe(s.data.rows,p),s.data.autocomplete)for(let l in s.data.autocomplete)z.value[l]=s.data.autocomplete[l];M.value=s.data.total,F.value=!1}catch(s){d("error",{detail:s.message})}},$=()=>{x()};f({refresh:$});const{cacheAction:se,cache:Ke}=Se(),N=async o=>{let{data:n,newValue:s,field:l}=o;const a={id:n.id,[l]:s};se({type:"update",payload:a});try{(await u.update(a)).success&&(n[l]=s)}catch(t){d("error",{detail:t.message},!0)}},de=async o=>{h.value=o,await x(o)},ue=async o=>{h.value=o,await x(o)},ce=o=>o.toString().replace(".",","),i=e.ref({}),K=e.ref(!1),g=e.ref(!1),pe=o=>{i.value={...o},g.value=!0},fe=()=>{g.value=!1,K.value=!1},me=async()=>{if(K.value=!0,i.value.id)try{await u.update(i.value),k.value[ye(Number(i.value.id))]=i.value,g.value=!1,i.value={}}catch(o){d("error",{detail:o.message})}else try{await u.create(i.value),$(),g.value=!1,i.value={}}catch(o){d("error",{detail:o.message})}},ye=o=>{let n=-1;for(let s=0;s<k.value.length;s++)if(k.value[s].id===o){n=s;break}return n},ve=()=>{i.value={},K.value=!1,g.value=!0},P=e.ref(!1),O=e.ref(!1),be=o=>{i.value=o,P.value=!0},he=async()=>{try{await u.delete({ids:i.value.id}),k.value=k.value.filter(o=>o.id!==i.value.id),P.value=!1,i.value={}}catch(o){d("error",{detail:o.message})}},ke=()=>{w.value&&w.value.length&&(O.value=!0)},we=async()=>{const o=w.value.map(n=>n.id).join(",");try{await u.delete({ids:o}),k.value=k.value.filter(n=>!w.value.includes(n)),O.value=!1,w.value=null}catch(n){d("error",{detail:n.message})}},w=e.ref(),B=e.ref(!1),Ve=o=>{B.value=o.checked,B.value?(B.value=!0,w.value=k.value):(B.value=!1,w.value=[])},ge=()=>{B.value=w.value.length===M.value},Be=()=>{B.value=!1},j=o=>{if(o.readonly)return"readonly"};return(o,n)=>{const s=e.resolveComponent("PVTables",!0);return e.openBlock(),e.createElementBlock("div",De,[e.createVNode(e.unref(Ue),{class:"p-mb-4"},{start:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(_).filter(l=>l.head),l=>(e.openBlock(),e.createBlock(e.unref(V),{icon:l.icon,label:l.label,class:e.normalizeClass(l.class),onClick:l.head_click},null,8,["icon","label","class","onClick"]))),256))]),end:e.withCtx(()=>[e.createVNode(e.unref(V),{icon:"pi pi-refresh",class:"p-button-rounded p-button-success",onClick:$}),e.createVNode(e.unref(V),{type:"button",icon:"pi pi-filter-slash",onClick:n[0]||(n[0]=l=>ne())})]),_:1}),e.createVNode(e.unref(Ce),{value:k.value,lazy:"",paginator:"",first:W.value,rows:10,rowsPerPageOptions:[10,60,30,10],ref_key:"dt",ref:q,dataKey:"id",totalRecords:M.value,loading:F.value,onPage:n[2]||(n[2]=l=>de(l)),onSort:n[3]||(n[3]=l=>ue(l)),sortMode:"multiple",editMode:"cell",onCellEditComplete:N,selection:w.value,"onUpdate:selection":n[4]||(n[4]=l=>w.value=l),selectAll:B.value,onSelectAllChange:Ve,onRowSelect:ge,onRowUnselect:Be,filters:m.value,"onUpdate:filters":n[5]||(n[5]=l=>m.value=l),filterDisplay:"menu",globalFilterFields:Y.value,onFilter:n[6]||(n[6]=l=>oe(l)),expandedRows:U.value,"onUpdate:expandedRows":n[7]||(n[7]=l=>U.value=l),showGridlines:"",scrollable:"",scrollHeight:"50rem",resizableColumns:"",columnResizeMode:"expand"},{expansion:e.withCtx(l=>[e.createElementVNode("div",_e,[e.createVNode(s,{table:R.value[l.data.id],filters:Z.value[l.data.id]},null,8,["table","filters"])])]),default:e.withCtx(()=>[e.createVNode(e.unref(C),{selectionMode:"multiple",headerStyle:"width: 3rem"}),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(D.value.filter(l=>l.modal_only!=!0),l=>(e.openBlock(),e.createElementBlock(e.Fragment,{key:l.field},[l.field=="id"?(e.openBlock(),e.createBlock(e.unref(C),{key:0,field:"id",header:"id",style:{padding:"1rem 10px 1rem 10px"},sortable:""},{body:e.withCtx(({data:a,field:t})=>[e.createTextVNode(e.toDisplayString(a[t]),1)]),_:1})):l.type=="autocomplete"?(e.openBlock(),e.createBlock(e.unref(C),{key:1,field:l.field,header:l.label,class:e.normalizeClass(j(l)),style:{"min-width":"350px"},sortable:""},{body:e.withCtx(({data:a,field:t})=>{var r;return[e.createVNode(e.unref(te),{table:l.table,id:a[t],"onUpdate:id":y=>a[t]=y,options:(r=z.value[t])==null?void 0:r.rows,onSetValue:y=>N({data:a,field:t,newValue:a[t]}),disabled:l.readonly},null,8,["table","id","onUpdate:id","options","onSetValue","disabled"])]}),filter:e.withCtx(({filterModel:a})=>[e.createVNode(e.unref(S),{modelValue:a.value,"onUpdate:modelValue":t=>a.value=t,type:"text",class:"p-column-filter",placeholder:I(l)},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["field","header","class"])):l.type=="select"?(e.openBlock(),e.createBlock(e.unref(C),{key:2,field:l.field,header:l.label,class:e.normalizeClass(j(l)),style:{"min-width":"350px"},sortable:""},{body:e.withCtx(({data:a,field:t})=>{var r;return[e.createVNode(e.unref(ae),{id:a[t],"onUpdate:id":y=>a[t]=y,options:(r=L.value[t])==null?void 0:r.rows,onSetValue:y=>N({data:a,field:t,newValue:a[t]}),disabled:l.readonly},null,8,["id","onUpdate:id","options","onSetValue","disabled"])]}),filter:e.withCtx(({filterModel:a})=>[e.createVNode(e.unref(S),{modelValue:a.value,"onUpdate:modelValue":t=>a.value=t,type:"text",class:"p-column-filter",placeholder:I(l)},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["field","header","class"])):(e.openBlock(),e.createBlock(e.unref(C),{key:3,field:l.field,header:l.label,class:e.normalizeClass(j(l)),style:{"min-width":"350px"},sortable:""},e.createSlots({body:e.withCtx(({data:a,field:t})=>[l.type=="decimal"?(e.openBlock(),e.createElementBlock(e.Fragment,{key:0},[e.createTextVNode(e.toDisplayString(ce(a[t])),1)],64)):l.type=="boolean"?(e.openBlock(),e.createBlock(e.unref(ee),{key:1,modelValue:a[t],"onUpdate:modelValue":r=>a[t]=r,onKeydown:n[1]||(n[1]=e.withKeys(e.withModifiers(()=>{},["stop"]),["tab"])),onChange:r=>N({data:a,field:t,newValue:a[t]}),disabled:l.readonly},null,8,["modelValue","onUpdate:modelValue","onChange","disabled"])):l.type==="date"?(e.openBlock(),e.createBlock(e.unref(le),{key:2,"model-value":a[t],"onUpdate:modelValue":r=>N({data:a,field:t,newValue:r}),disabled:l.readonly},null,8,["model-value","onUpdate:modelValue","disabled"])):(e.openBlock(),e.createElementBlock(e.Fragment,{key:3},[e.createTextVNode(e.toDisplayString(a[t]),1)],64))]),filter:e.withCtx(({filterModel:a})=>[e.createVNode(e.unref(S),{modelValue:a.value,"onUpdate:modelValue":t=>a.value=t,type:"text",class:"p-column-filter",placeholder:I(l)},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},[!["boolean","date"].includes(l.type)&&!l.readonly?{name:"editor",fn:e.withCtx(({data:a,field:t})=>[l.type=="textarea"?(e.openBlock(),e.createBlock(e.unref(X),{key:0,modelValue:a[t],"onUpdate:modelValue":r=>a[t]=r,rows:"1"},null,8,["modelValue","onUpdate:modelValue"])):l.type=="number"?(e.openBlock(),e.createBlock(e.unref(E),{key:1,modelValue:a[t],"onUpdate:modelValue":r=>a[t]=r},null,8,["modelValue","onUpdate:modelValue"])):l.type=="decimal"?(e.openBlock(),e.createBlock(e.unref(E),{key:2,modelValue:a[t],"onUpdate:modelValue":r=>a[t]=r,minFractionDigits:l.FractionDigits,maxFractionDigits:l.FractionDigits},null,8,["modelValue","onUpdate:modelValue","minFractionDigits","maxFractionDigits"])):(e.openBlock(),e.createBlock(e.unref(S),{key:3,modelValue:a[t],"onUpdate:modelValue":r=>a[t]=r},null,8,["modelValue","onUpdate:modelValue"]))]),key:"0"}:void 0]),1032,["field","header","class"]))],64))),128)),A.value?(e.openBlock(),e.createBlock(e.unref(C),{key:0,exportable:!1,style:{"white-space":"nowrap"}},{body:e.withCtx(l=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(_).filter(a=>a.row),a=>(e.openBlock(),e.createBlock(e.unref(V),{icon:a.icon,class:e.normalizeClass(a.class),onClick:t=>a.click(l.data,D.value)},null,8,["icon","class","onClick"]))),256))]),_:1})):e.createCommentVNode("",!0)]),_:1},8,["value","first","totalRecords","loading","selection","selectAll","filters","globalFilterFields","expandedRows"]),e.createVNode(e.unref(G),{visible:g.value,"onUpdate:visible":n[8]||(n[8]=l=>g.value=l),style:{width:"450px"},header:"Редактировать",modal:!0,class:"p-fluid"},{footer:e.withCtx(()=>[e.createVNode(e.unref(V),{label:"Отмена",icon:"pi pi-times",class:"p-button-text",onClick:fe}),e.createVNode(e.unref(V),{label:"Сохранить",icon:"pi pi-check",class:"p-button-text",onClick:me})]),default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(D.value.filter(l=>l.table_only!=!0),l=>{var a,t;return e.openBlock(),e.createElementBlock("div",Ee,[e.createElementVNode("label",{for:l.field},e.toDisplayString(l.label),9,Te),l.field=="id"?(e.openBlock(),e.createElementBlock("p",{key:0,id:l.field},e.toDisplayString(i.value[l.field]),9,Ie)):l.type=="textarea"?(e.openBlock(),e.createBlock(e.unref(X),{key:1,id:l.field,modelValue:i.value[l.field],"onUpdate:modelValue":r=>i.value[l.field]=r,modelModifiers:{trim:!0},disabled:l.readonly},null,8,["id","modelValue","onUpdate:modelValue","disabled"])):l.type=="number"?(e.openBlock(),e.createBlock(e.unref(E),{key:2,id:l.field,modelValue:i.value[l.field],"onUpdate:modelValue":r=>i.value[l.field]=r,disabled:l.readonly},null,8,["id","modelValue","onUpdate:modelValue","disabled"])):l.type=="autocomplete"?(e.openBlock(),e.createBlock(e.unref(te),{key:3,id:i.value[l.field],"onUpdate:id":r=>i.value[l.field]=r,table:l.table,options:(a=z.value[l.field])==null?void 0:a.rows,disabled:l.readonly},null,8,["id","onUpdate:id","table","options","disabled"])):l.type=="select"?(e.openBlock(),e.createBlock(e.unref(ae),{key:4,id:i.value[l.field],"onUpdate:id":r=>i.value[l.field]=r,options:(t=L.value[l.field])==null?void 0:t.rows,disabled:l.readonly},null,8,["id","onUpdate:id","options","disabled"])):l.type=="decimal"?(e.openBlock(),e.createBlock(e.unref(E),{key:5,id:l.field,modelValue:i.value[l.field],"onUpdate:modelValue":r=>i.value[l.field]=r,minFractionDigits:l.FractionDigits,maxFractionDigits:l.FractionDigits,disabled:l.readonly},null,8,["id","modelValue","onUpdate:modelValue","minFractionDigits","maxFractionDigits","disabled"])):l.type=="boolean"?(e.openBlock(),e.createBlock(e.unref(ee),{key:6,id:l.field,modelValue:i.value[l.field],"onUpdate:modelValue":r=>i.value[l.field]=r,disabled:l.readonly},null,8,["id","modelValue","onUpdate:modelValue","disabled"])):l.type==="date"?(e.openBlock(),e.createBlock(e.unref(le),{key:7,modelValue:i.value[l.field],"onUpdate:modelValue":r=>i.value[l.field]=r,disabled:l.readonly},null,8,["modelValue","onUpdate:modelValue","disabled"])):(e.openBlock(),e.createBlock(e.unref(S),{key:8,id:l.field,modelValue:i.value[l.field],"onUpdate:modelValue":r=>i.value[l.field]=r,modelModifiers:{trim:!0},disabled:l.readonly},null,8,["id","modelValue","onUpdate:modelValue","disabled"]))])}),256))]),_:1},8,["visible"]),e.createVNode(e.unref(G),{visible:P.value,"onUpdate:visible":n[10]||(n[10]=l=>P.value=l),style:{width:"450px"},header:"Confirm",modal:!0},{footer:e.withCtx(()=>[e.createVNode(e.unref(V),{label:"Нет",icon:"pi pi-times",class:"p-button-text",onClick:n[9]||(n[9]=l=>P.value=!1)}),e.createVNode(e.unref(V),{label:"Да",icon:"pi pi-check",class:"p-button-text",onClick:he})]),default:e.withCtx(()=>[e.createElementVNode("div",qe,[Me,i.value?(e.openBlock(),e.createElementBlock("span",Ae,"Вы хотите удалить эту запись?")):e.createCommentVNode("",!0)])]),_:1},8,["visible"]),e.createVNode(e.unref(G),{visible:O.value,"onUpdate:visible":n[12]||(n[12]=l=>O.value=l),style:{width:"450px"},header:"Confirm",modal:!0},{footer:e.withCtx(()=>[e.createVNode(e.unref(V),{label:"Нет",icon:"pi pi-times",class:"p-button-text",onClick:n[11]||(n[11]=l=>O.value=!1)}),e.createVNode(e.unref(V),{label:"Да",icon:"pi pi-check",class:"p-button-text",onClick:we})]),default:e.withCtx(()=>[e.createElementVNode("div",Le,[Re,i.value?(e.openBlock(),e.createElementBlock("span",ze,"Вы хотите удалить отмеченные записи?")):e.createCommentVNode("",!0)])]),_:1},8,["visible"])])}}},$e={install:(c,f)=>{c.component(H.name,H)}};exports.PVTables=H;exports.default=$e;
